var scrat={docController:null,dsPanelInst:null,viewPanelInst:null,initial_data:null,currentSheetID:"",debugMode:!1,gridTitleShiftable:!0,animationThreshold:200,dsAttrIDList:[],dsAttrNameList:[],dsMeasIDList:[],dsMeasNameList:[],geoData:[],isMobileEnv:void 0,ClickMethod:"ClickMethodSingle",serverPending:0,loadingIconCnt:0,initCommandsCount:3,displayMtd:0,disableAnimation:!1,datasetWidth:200,helper:_,appType:0};scrat.navPara={userProfile:null,loginPage:!1,sid:null,uid:null,urlJump:!1},scrat.chartCommuData={lastExtentTOEnd:null,showTiming:!1,dateIDs:null,dateDescs:null,revenueData:null,stat_abs:null,stat_rel:null,stat_period_abs:null,stat_period_rel:null},scrat.globalConst={borderThick:1,padding:5,titleHeight:50,panelStartX:210,topPanelHeight:102,analyzePanelMinWidth:200,minScreenWidth:1100,minScreenHeight:500,analyzePanelPerc:.7,panelSwitchHeight:25,btmHeight:0,chunkSize:200,chartChunkSize:2e3,fileUploadLimit:4194304,derivedDataFileUploadLimit:209715200,chartDataLimit:1e5,fileNumLimit:3,scrollBarSize:17,defaultSheetName:"2jdf#$70fejf()#40@$0JFQICiwof)(!!@3FIE"},function(){var t=scrat.helper;scrat.mixin=function(t,e){if(t){e||(e={});var i,n=/this\.superCall/,s=function(t,e){return function(){var i,n=this.superCall;return this.superCall=e,i=t.apply(this,arguments||[]),this.superCall=n,i}};for(i in t)e[i]="function"==typeof t[i]&&n.test(t[i])?s(t[i],e[i]):t[i]}return e},scrat.classDef=function(t,e,i){function n(t){t&&t.dontInit||!this.init||this.init(t)}t&&(n.prototype=new t({dontInit:!0}),n.prototype.constructor=n);var s,r=e&&e.length||0;for(s=0;r>s;s++)scrat.mixin(e[s],n.prototype);return i&&scrat.mixin(i,n.prototype),n},scrat.combine=function(t,e){if(e){t=t||{};var i;for(i in e)t[i]=e[i]}return t},scrat.Model=scrat.classDef(null,null,{cid:t.uniqueId("c"),attributes:{},listeners:{},alwaysListener:[],modelSet:null,set:function(e,i,n){var s,r,l,o,a,h,u,c,d,f,p;if(null===e)return this;"object"==typeof e?(r=e,n=i):(r={})[e]=i,o=[],n||(n={}),l=n.unset,a=n.silent,this.changed={},h=this.attributes;for(s in r)i=r[s],t.isEqual(h[s],i)?delete this.changed[s]:(o.push(s),this.changed[s]=i),l?delete h[s]:h[s]=i;if(!a){for(u=0,d=o.length;d>u;u++)if(this.listeners[o[u]]instanceof Array)for(p=this.listeners[o[u]],c=0,f=p.length;f>c;c++)"function"==typeof p[c]&&p[c].call();if(this.alwaysListener instanceof Array)for(p=this.alwaysListener,c=0,f=p.length;f>c;c++)"function"==typeof p[c]&&p[c].call()}return this},getProp:function(t){return this.attributes[t]},bindCbk:function(t,e){"string"==typeof e?(this.listeners[e]||(this.listeners[e]={}))[e]=t:this.alwaysListener.push(t)},init:function(t){return scrat.combine(this,t),this}});var e=["keys","values","pairs","invert","pick","omit"];t.each(e,function(e){scrat.Model.prototype[e]=function(){var i=arguments.slice();return i.unshift(this.attributes),t[e].apply(t,i)}}),scrat.ModelSet=scrat.classDef(null,null,{cid:t.uniqueId("s"),attributes:{},listeners:{},alwaysListener:null,length:0,models:[],_byId:{},listenTo:function(){},init:function(t){scrat.combine(this,t)},add:function(e,i){return this.set(e,t.extend({merge:!1},i,addOptions))},remove:function(e,i){var n=!t.isArray(e);e=n?[e]:t.clone(e),i||(i={});var s,r,l,o;for(s=0,r=e.length;r>s;s++)o=e[s]=this.get(e[s]),o&&(delete this._byId[o.cid],l=this.indexOf(o),this.models.splice(l,1),this.length--,i.silent||(i.index=l,o.trigger("remove",o,this,i)),this._removeReference(o,i));return n?e[0]:e},set:function(e,i){i=t.defaults({},i,setOptions),i.parse&&(e=this.parse(e,i));var n=!t.isArray(e);e=n?e?[e]:[]:t.clone(e);var s,r,l,o,a,h,u,c=i.at,d=this.model,f=this.comparator&&null==c&&i.sort!==!1,p=t.isString(this.comparator)?this.comparator:null,m=[],g=[],v={},y=i.add,b=i.merge,_=i.remove,I=!f&&y&&_?[]:!1;for(s=0,r=e.length;r>s;s++){if(a=e[s]||{},l=a instanceof Model?o=a:a[d.prototype.idAttribute||"id"],h=this.get(l))_&&(v[h.cid]=!0),b&&(a=a===o?o.attributes:a,i.parse&&(a=h.parse(a,i)),h.set(a,i),f&&!u&&h.hasChanged(p)&&(u=!0)),e[s]=h;else if(y){if(o=e[s]=this._prepareModel(a,i),!o)continue;m.push(o),this._addReference(o,i)}o=h||o,!I||!o.isNew()&&v[o.id]||I.push(o),v[o.id]=!0}if(_){for(s=0,r=this.length;r>s;++s)v[(o=this.models[s]).cid]||g.push(o);g.length&&this.remove(g,i)}if(m.length||I&&I.length)if(f&&(u=!0),this.length+=m.length,null!=c)for(s=0,r=m.length;r>s;s++)this.models.splice(c+s,0,m[s]);else{I&&(this.models.length=0);var w=I||m;for(s=0,r=w.length;r>s;s++)this.models.push(w[s])}if(u&&this.sort({silent:!0}),!i.silent){for(s=0,r=m.length;r>s;s++)(o=m[s]).trigger("add",o,this,i);(u||I&&I.length)&&this.trigger("sort",this,i)}return n?e[0]:e},reset:function(e,i){i||(i={});for(var n=0,s=this.models.length;s>n;n++)this._removeReference(this.models[n],i);return i.previousModels=this.models,this._reset(),e=this.add(e,t.extend({silent:!0},i)),i.silent||this.trigger("reset",this,i),e},push:function(e,i){return this.add(e,t.extend({at:this.length},i))},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t),e},unshift:function(e,i){return this.add(e,t.extend({at:0},i))},shift:function(t){var e=this.at(0);return this.remove(e,t),e},slice:function(){return slice.apply(this.models,arguments)},get:function(t){return null==t?void 0:this._byId[t]||this._byId[t.id]||this._byId[t.cid]},at:function(t){return this.models[t]},where:function(e,i){return t.isEmpty(e)?i?void 0:[]:this[i?"find":"filter"](function(t){for(var i in e)if(e[i]!==t.get(i))return!1;return!0})},findWhere:function(t){return this.where(t,!0)},create:function(e,i){return i=i?t.clone(i):{},(e=this._prepareModel(e,i))?(i.wait||this.add(e,i),e):!1},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(e,i){if(e instanceof Model)return e;i=i?t.clone(i):{},i.collection=this;var n=new this.model(e,i);return n},_addReference:function(t){this._byId[t.cid]=t,t.collection||(t.collection=this),t.on("all",this._onModelEvent,this)},_removeReference:function(t){this===t.collection&&delete t.collection,t.off("all",this._onModelEvent,this)}});var i=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample"];t.each(i,function(e){scrat.ModelSet.prototype[e]=function(){var i=arguments.slice();return i.unshift(this.models),t[e].apply(t,i)}});var n=/^(\S+)\s*(.*)$/;scrat.View=scrat.classDef(null,null,{ID:"",cid:t.uniqueId("view"),width:-1,height:-1,el:null,$el:null,controller:null,doLayout:function(t,e){this.width!==t&&(this.$el.width(t),this.width=t),this.height!==e&&(this.$el.height(e),this.height=e)},$Obj:function(){return this.$el||(""===this.ID?null:$(this.ID))},init:function(t){scrat.combine(this,t),this.ID&&(this.$el=$(this.ID)),this.$el&&(this.el=this.$el[0]),this.el&&(this.el.data_view=this),this.delegateEvents()},listenTo:function(t,e,i){if(i)this.$el.on(t,e,i);else{var n=e;this.$el.on(t,n)}},render:function(){return this},remove:function(){return this._removeElement(),this},_removeElement:function(){this.$el.remove()},setElement:function(t){return this.undelegateEvents(),this._setElement(t),this.delegateEvents(),this},_setElement:function(t){this.$el=t instanceof Backbone.$?t:Backbone.$(t),this.el=this.$el[0]},delegateEvents:function(e){if(!e&&!(e=t.result(this,"events")))return this;for(var i in e){var s=e[i];if(t.isFunction(s)||(s=this[e[i]]),s){var r=i.match(n),l=r[1],o=r[2];s=t.bind(s,this),l+=".delegateEvents"+this.cid,""===o?this.$el.on(l,s):this.$el.on(l,o,s)}}return this}})}();
;scrat.Enums={UnitType:{UNKNOWN:"unknown",ATTR:"attr",MEAS:"meas"},MeasType:{NORMAL:"meas",DERIVED:"derived"},ViewLayoutType:{GRID:"grid",CHART:"chart"},ChartType:{BAR:"bar",LINE:"line",DOT:"dot",MAP:"map"},ViewStatus:{SUCCESS:1,NODATA:2,FILTER_EXCLUDE:3,SERVER_ERROR:4},TypeMap:{grid:1,line:2,fline:3,bar:4,area:5,map:6},SortStatus:{DEFAULT:"",ASC:"asc",DEC:"desc"},UnitStatus:{UNKNOWN:0,SELECTED:1,UNSELECTED:2,GREYOUT:3},MeasFilterType:{EMPTY:"",GT:"gt",LT:"lt",VALUE_BETWEEN:"bw",TOP:"tp",BOTTOM:"bt",RANGE:"rng",TOPPER:"tp%",BOTTOMPER:"bt%",RANGEPER:"rng%",NOTNULL:"nn",NULL:"nu",GE:"ge",LE:"le",IN:"in",EQ:"eq"},MeasFilterCategory:{VALUE:0,RANK:1,RANKPER:2},MeasFormatType:{NUMBER:"f",SCIENCE:"e",PERCENT:"%",WAN:"w",YI:"y",INT:".0f"},DisplayMethod:{ALL:0,VIEWERTITLE:1,VIEWER:2},BoxType:{VIEWER:0,HOR_CONTAINER:1,VER_CONTAINER:2},APPType:{PLATFORM:0,STOCK:1},OPTranslate:{ge:"大于等于",le:"小于等于",gt:"大于",lt:"小于",eq:"等于",bw:"区间",tp:"排名最大",bt:"排名最小",rng:"排名区间","tp%":"排名%最大","bt%":"排名%最小","rng%":"排名%区间"},PeriodTranslate:{day:"日线",week:"周线",month:"月线"},ALL:"all",DEFAULT_POPUP_MASK_ID:"#popupMask",DEFAU_FORMAT_TYP:"f",DEFAU_FORMAT_PREC:2,SWITCH_NEWMEAS:"..new../*&Measure.%$.",SWITCH_USED:"..u../*&sed.%$.",SWITCH_PREFIX:".../#$|$)*(#.*",HOLDING_REFERENCE_LIST:["000300","000016","399905","000902","399006","399005"]},scrat.GlobalColors20=[2586294,11388649,16219904,16432243,2990626,9888134,14165023,16291732,9790911,13021142,9262665,12950675,14972355,16299475,8355711,13092807,12369664,14408841,4046545,10279654],scrat.GlobalColors10=[2586294,16219904,2990626,14165023,9790911,9262665,14972355,8355711,12369664,4046545],Number.prototype.div=function(t){return scrat.utility.accDiv(this,t)},Number.prototype.mul=function(t){return scrat.utility.accMul(t,this)},Number.prototype.add=function(t){return scrat.utility.accAdd(t,this)},scrat.utility={checkFocus:function(t,e){var a=t.offset();return e.left>=a.left&&e.top>=a.top&&e.left<=a.left+t.width()&&e.top<=a.top+t.height()},accDiv:function accDiv(arg1,arg2){var r1,r2,t1=0,t2=0;try{t1=arg1.toString().split(".")[1].length}catch(e){}try{t2=arg2.toString().split(".")[1].length}catch(e){}with(Math)return r1=Number(arg1.toString().replace(".","")),r2=Number(arg2.toString().replace(".","")),r1/r2*pow(10,t2-t1)},accMul:function(t,e){var a=0,r=t.toString(),n=e.toString();try{a+=r.split(".")[1].length}catch(i){}try{a+=n.split(".")[1].length}catch(i){}return Number(r.replace(".",""))*Number(n.replace(".",""))/Math.pow(10,a)},accAdd:function(t,e){var a,r,n;try{a=t.toString().split(".")[1].length}catch(i){a=0}try{r=e.toString().split(".")[1].length}catch(i){r=0}return n=Math.pow(10,Math.max(a,r)),(t*n+e*n)/n},formatNumbe:function(t,e,a){if("number"!=typeof t)return"string"==typeof t?t:"";if(isNaN(t))return"";var r=scrat.utility.parseFormatStr(e);return r.type===scrat.Enums.MeasFormatType.SCIENCE?t.toExponential(r.precision):r.type===scrat.Enums.MeasFormatType.PERCENT?(t=t.mul(100),t.toFixed(r.precision)+"%"):r.type===scrat.Enums.MeasFormatType.WAN?(t=t.div(1e4),t.toFixed(r.precision)+(a?"万":"")):r.type===scrat.Enums.MeasFormatType.YI?(t=t.div(1e8),t.toFixed(r.precision)+(a?"亿":"")):t.toFixed(r.precision)},parseFormatStr:function(t){var e=scrat.Enums.DEFAU_FORMAT_TYP,a=scrat.Enums.DEFAU_FORMAT_PREC,r=t.indexOf("#");if(-1!==r&&(t=t.substr(0,r)),t){switch(t.charAt(t.length-1)){case"f":e=scrat.Enums.MeasFormatType.NUMBER;break;case"%":e=scrat.Enums.MeasFormatType.PERCENT;break;case"e":e=scrat.Enums.MeasFormatType.SCIENCE;break;case"w":e=scrat.Enums.MeasFormatType.WAN;break;case"y":e=scrat.Enums.MeasFormatType.YI}if(t.length>=3){var n=parseInt(t.slice(1,t.length-1));isNaN(n)||(a=n)}}return{type:e,precision:a}},packFormatStr:function(t,e){return null===t&&null===e?null:"."+(e||"")+(t||"")},getFormatPostFix:function(t){var e=scrat.utility.parseFormatStr(t).type;return e===scrat.Enums.MeasFormatType.WAN?"(万)":e===scrat.Enums.MeasFormatType.YI?"(亿)":""},getFormatPostFix1:function(t){var e=scrat.utility.parseFormatStr(t).type;return e===scrat.Enums.MeasFormatType.WAN?"(万)":e===scrat.Enums.MeasFormatType.YI?"(亿)":e===scrat.Enums.MeasFormatType.PERCENT?"(%)":""},retrieveNameByID:function(t,e){var a=null;return $.each(t,function(t,r){r.id===e&&(a=r.name)}),a},deepCopy:function(t){if(Array.isArray(t))return t.map(function(t){return scrat.utility.deepCopy(t)});if("object"==typeof t){var e={};for(var a in t)t.hasOwnProperty(a)&&(e[a]="object"==typeof t[a]?scrat.utility.deepCopy(t[a]):t[a]);return e}return t},checkPrivilege:function(t,e){var a=t+"Privilege";return scrat[a][e]&&scrat.navPara.userProfile&&(scrat[a][e].group&&scrat.navPara.userProfile.group>=scrat[a][e].group||scrat[a][e].level&&scrat.navPara.userProfile.level>=scrat[a][e].level||scrat[a][e].title&&scrat.navPara.userProfile.title)?!0:!1},retrieveIDByName:function(t,e){var a=null;return $.each(t,function(t,r){r.name===e&&(a=r.id)}),a},retrieveObjByProp:function(t,e,a){var r=null;return $.each(t,function(t,n){n[e]===a&&(r=n)}),r},arrToStr:function(t,e){var a,e,r="(";for(a=0,e=Math.min(t.length,e);e>a;a++)r+=t[a],a!==e-1&&(r+=", ");return r+=")"},getUserRole:function(t){return 1==t?"(普通用户)":2==t?"(高级会员)":3==t?"(VIP会员)":t>3?"(管理员)":""},getInputValidatMsg:function(t,e,a,r,n){var i=t+(scrat.utility.checkNotExist(r)||scrat.utility.checkNotExist(a)?scrat.utility.checkNotExist(a)?scrat.utility.checkNotExist(r)?"":"须小于等于"+r:"须大于等于"+a:"须在"+a+"到"+r+"之间");return isNaN(e)||""===e?i:n&&parseFloat(e)-parseInt(e)>1e-8?i:!scrat.utility.checkNotExist(a)&&parseFloat(e)<a?i:!scrat.utility.checkNotExist(r)&&parseFloat(e)>r?i:null},getArrValues:function(t,e){var a,r,n=[];for(a=0,r=t.length;r>a;a++)void 0!==t[a][e]&&n.push(t[a][e]);return n},convertPixelToNum:function(t){var e=t.toString().indexOf("px");return-1!==e&&e===t.length-2&&(t=t.substr(0,t.length-2)),parseInt(t)},getRawValueWithFormat:function(t,e){return e===scrat.Enums.MeasFormatType.PERCENT?parseFloat(t).div(100):e===scrat.Enums.MeasFormatType.WAN?parseFloat(t).mul(1e4):e===scrat.Enums.MeasFormatType.YI?parseFloat(t).mul(1e8):t},getDisplayValueWithFormat:function(t,e){return e===scrat.Enums.MeasFormatType.PERCENT?parseFloat(t).mul(100):e===scrat.Enums.MeasFormatType.WAN?parseFloat(t).div(1e4):e===scrat.Enums.MeasFormatType.YI?parseFloat(t).div(1e8):t},getCookieName:function(t){return t===scrat.stockEnums.TempFundStrategyCookieName},getDefaultColor:function(t,e){return 4>=e?scrat.GlobalColors20[2*t]:scrat.GlobalColors20[t%scrat.GlobalColors20.length]},getColorInRange:function(t,e,a,r){if(t=t>1?1:0>t?0:t,t>=0&&1>=t){var n,i,s,c=256,o=t*c,u=e>>16,l=a>>16,d=(65280&e)>>8,p=(65280&a)>>8,m=255&e,f=255&a;return n=u+Math.floor(o*(l-u)/c),i=d+Math.floor(o*(p-d)/c),s=m+Math.floor(o*(f-m)/c),s+(i<<8)+(n<<16)}return r},getCSSColor:function(t){var e=16777216+t;return"#"+e.toString(16).substring(1).toUpperCase()},num2Color:function(t){var e,a=[99,248],r=[190,105],n=[123,107];return 0>t&&(t=0),e=[a,r,n].map(function(e){return e[0]+(e[1]-e[0])*t}),e.join(",")},checkResponseData:function(t){return"ok"===t.status&&t.data},checkResponseOK:function(t){return"ok"===t.status},getPureID:function(t){return t.replace(/[&\|\\\*\.\(\)  ^%$#@\-]/g,"")},checkPosInteger:function(t){var e=/^[1-9]+[0-9]*]*$/;return e.test(t)},measureTextWidth:function(t,e,a,r){if(""===t)return 0;" "===t&&(t=" ");var n=e&&e.fontFamily?e.fontFamily:"inherit",i=e&&e.fontSize?e.fontSize:"12px",s=e&&e.fontStyle?e.fontStyle:"normal",c=e&&e.fontWeight?e.fontWeight:"normal";"number"==typeof i&&(i+="px"),r=r||"auto",a=a||0,"number"==typeof r&&(r+="px");var o=document.getElementById("txtMeasure");return o.style.width="auto",o.style.height=r,o.style.fontFamily=n,o.style.fontSize=i,o.style.fontStyle=s,o.style.fontWeight=c,o.innerHTML=t,Math.ceil(o.offsetWidth)+a},measureTextHeight:function(t,e,a,r,n){if(""===t)return 0;" "===t&&(t=" ");var i=e&&e.fontFamily?e.fontFamily:"inherent",s=e&&e.fontSize?e.fontSize:"12px",c=e&&e.fontStyle?e.fontStyle:"normal",o=e&&e.fontWeight?e.fontWeight:"normal",n=n||"normal";"number"==typeof s&&(s+="px"),r=r||"auto",a=a||0,"number"==typeof r&&(r+="px");var u=document.getElementById("txtMeasure");return u.style.heigth="auto",u.style.width=r,u.style.fontFamily=i,u.style.fontSize=s,u.style.fontStyle=c,u.style.fontWeight=o,u.style.wordBreak=n,u.innerHTML=t,u.offsetHeight+a},measureTextSize:function(t,e,a){return{width:scrat.utility.measureTextWidth(t,e,a),height:scrat.utility.measureTextHeight(t,e,a)}},truncateTextToLine:function(t,e){var a=document.getElementById("txtMeasure"),r=$(t);a.className=t.className,a.style.whiteSpace="nowrap",a.style.fontSize=r.css("font-size"),a.style.fontFamily=r.css("font-family"),a.style.fontWeight=r.css("font-weight"),a.style.fontStyle=r.css("font-style");var n=a.innerHTML=r[0].originalStr||r.text(),i=n;if(a.offsetWidth>e){for(var s=0,c=n.length-1;c>=s;){var o=Math.round((s+c)/2),u=n.substr(0,o+1),l=n.substr(0,o+2);a.innerHTML=u;var d=a.offsetWidth;a.innerHTML=l;var p=a.offsetWidth;if(e>=d&&p>e)break;d>e?c=o-1:e>=p&&(s=o+1)}if(i=n.substr(0,o+1),i.length<n.length){" "===i.charAt(i.length-1)&&(i=i.substr(0,i.length-1));var m=i.lastIndexOf(" "),f=i.length-1-m;if(-1!==m&&f>=2&&6>=f)i=i.substr(0,i.length-f-1)+"...";else{for(;i.length>0;)if(i=i.substr(0,i.length-1),a.innerHTML=i+"...",a.offsetWidth<=e){i+="...";break}0===i.length&&(i="...")}}return r.text(i),!0}return n!==r.text()&&r.text(n),!1},handleTruncationTxt:function(t){var e=$(t),a=e[0].originalStr||e.text(),r=e.css("max-width"),n=r&&"none"!==r?r:e.actual("width"),i=scrat.utility.truncateTextToLine(t,scrat.utility.convertPixelToNum(n));scrat.utility.unbindTooltip(e),i&&scrat.utility.bindTooltip(e,a)},unbindTooltip:function(t){t.unbind("mousemove"),t.unbind("mouseleave"),t.unbind("mouseenter")},bindTooltip:function(t,e){var a;t.mousemove(function(t){var a,r,n=t.clientX+20,i=t.clientY-40,s=$("#generalTooltip");s.empty(),s.append($("<span>"+e+"</span>")),a=s.outerWidth(),r=s.outerHeight(),n=a+n<=window.innerWidth?n:t.clientX-20-a,i=r+i<=window.innerHeight?i:t.clientY-r,s.css(scrat.utility.getGlobalOffset(i,n))}).mouseleave(function(){clearTimeout(a),$("#generalTooltip").hide()}).mouseenter(function(){a=setTimeout(function(){$("#generalTooltip").show()},200)})},getGlobalOffset:function(t,e){var a=$("body");return{top:t+a.scrollTop(),left:e+a.scrollLeft()}},calcLinearTicks:function(t,e,a){var r=e>t?[t,e]:[e,t],n=r[1]-r[0],i=Math.pow(10,Math.floor(Math.log(n/a)/Math.LN10)),s=a/n*i;.15>=s?i*=10:.35>=s?i*=5:.75>=s&&(i*=2),r[0]=Math.ceil(r[0]/i)*i,r[1]=Math.floor(r[1]/i)*i+.5*i,r[2]=i,t=r[0],e=r[1];for(var c=1;i*c%1;)c*=10;var o,u=[],l=-1;if(t*=c,e*=c,i*=c,0>i)for(;(o=t+i*++l)>e;)u.push(o/c);else for(;(o=t+i*++l)<e;)u.push(o/c);return u},isMobile:function(){var t=scrat.utility.getURLPara("c"),e=scrat.utility.getCookie("c");return t?(scrat.isMobileEnv="web"!==t,scrat.utility.setCookie("c",t)):e?scrat.isMobileEnv="web"!==e:void 0===scrat.isMobileEnv&&(scrat.isMobileEnv=scrat.utility.isRealMobile()),scrat.isMobileEnv},isRealMobile:function(){var t=navigator.userAgent.toLowerCase();return null!==t.match(/\ipad|iphone|midp|rv:1\.2\.3\.4|ucweb|android|windows ce|mobile/)},fromWechat:function(){var t=scrat.utility.getURLPara("c"),e=scrat.utility.getCookie("c");return t?(scrat.isFromwechat="wechat"===t,scrat.utility.setCookie("c",t)):e?scrat.isFromwechat="wechat"===e:void 0===scrat.isFromwechat&&(scrat.isFromwechat=scrat.utility.isRealWechat()),scrat.isFromwechat},isRealWechat:function(){var t=navigator.userAgent.toLowerCase();return null!==t.match(/\MicroMessenger|micromessenger/)},translatAggFunc:function(t){var e=["sum","mean","max","min","latest","oldest","count"],a=["合计","平均","最大","最小","取新值","取旧值","计数"],r=e.indexOf(t);return-1!==r?a[r]:""},translateVisibility:function(t){return 1==t?"私有":2==t?"可看调仓":4==t?"可看收益":"可看定义"},checkScore:function(){var t,e=$("#tip-dialog .amount.selected").index()-$("#tip-dialog .amount:first").index();return e>=0?(t=0===e?1:1===e?5:2===e?10:3===e?20:4===e?50:parseInt($("#tip-dialog input.amount").val()),t>scrat.navPara.userProfile.score?($("#tip-dialog .error").text("您的余额不足").show(),-1):($("#tip-dialog .error").hide(),t)):-1},checkNotExist:function(t){return void 0===t||null===t},addPopup:function(t){scrat.passageView=t,$("body").append(t),t.show().css("z-index",1199),$(scrat.Enums.DEFAULT_POPUP_MASK_ID).show().height(Math.max($("body").height(),$(window).height())),scrat.popupMaskListenerAdded||($(scrat.Enums.DEFAULT_POPUP_MASK_ID).click(function(){scrat.utility.removePopup()}),scrat.popupMaskListenerAdded=!0)},addPopupOnFixedPos:function(t){t.css({top:$("body").scrollTop()+200,left:($("body").width()-$(t).width())/2}),scrat.utility.addPopup(t)},addFadeoutPopup:function(t,e,a){t.find("p").text(e),scrat.utility.addPopup(t);var r=$("body").scrollTop()+200,n=-1*$("#fadeout-tips").outerWidth()/2;t.css("top",r),t.css("margin-left",n),setTimeout(scrat.utility.removePopup,a)},prepareStatData:function(t,e,a){if(!t)return[];var r,n,i,s,c,o,u,l,d=[],p=[],m=[],f=[],h=0,y=0,v=0,g=0,E=[{key:"正收益累加",values:[]},{key:"负收益累加",values:[]}],b=[{key:"正收益次数",values:[]},{key:"负收益次数",values:[]}],T=30,S=function(t){return T>t?scrat.utility.formatNumbe(t/100+.01,".2%"):"> "+scrat.utility.formatNumbe(T/100,".2%")};for(c=0;T>=c;c++)d[c]=0,p[c]=0,m[c]=0,f[c]=0;for(c=0,u=t.length;u>c;c++)if(i=parseInt(_.keys(t[c])),!(e&&a&&(e>i||i>a)))for(r=_.toArray(t[c])[0],r instanceof Array||(r=[[r]]),o=0,l=r.length;l>o;o++)n=100*r[o][0],s=Math.min(Math.floor(Math.abs(n)),T),n>0?(d[s]++,m[s]+=r[o][0],h++,v+=r[o][0]):0>n&&(p[s]++,f[s]+=Math.abs(r[o][0]),y++,g+=Math.abs(r[o][0]));for(c=0,u=d.length;u>c;c++)E[0].values.push({x:S(c),y:m[c]||0}),E[1].values.push({x:S(c),y:f[c]||0}),b[0].values.push({x:S(c),y:d[c]||0}),b[1].values.push({x:S(c),y:p[c]||0});return[E,b,h,y,v,g]},prepareAllStatData:function(){var t,e;scrat.chartCommuData.lastExtentTOEnd&&(t=scrat.chartCommuData.dateIDs[scrat.chartCommuData.dateIDs.length-scrat.chartCommuData.lastExtentTOEnd[1]],e=scrat.chartCommuData.dateIDs[scrat.chartCommuData.dateIDs.length-scrat.chartCommuData.lastExtentTOEnd[0]]),scrat.statPeriodAbs=scrat.utility.prepareStatData(scrat.chartCommuData.stat_period_abs,t,e),scrat.statPeriodRel=scrat.utility.prepareStatData(scrat.chartCommuData.stat_period_rel,t,e),scrat.debugMode&&(scrat.statAbs=scrat.utility.prepareStatData(scrat.chartCommuData.stat_abs,t,e),scrat.statRel=scrat.utility.prepareStatData(scrat.chartCommuData.stat_rel,t,e))},renderStatArea:function(t,e){nv.addGraph(function(){var a,r=d3.scale.ordinal().range(["#d8241f","#24a221"]),n=function(t){return r(t.key)},i=-1!==t.indexOf("period")||"count"===scrat.currentStatType;return a=nv.models.multiBarChart().margin({top:30,right:20,bottom:50,left:i?35:80}).x(function(t){return t.x}).y(function(t){return t.y}).color(n).showControls(!1).stacked(!1).transitionDuration(300),a.yAxis.tickFormat(d3.format(i?".0f":",.2%")),$(t).empty(),$(t).append($('<svg class="graph"></svg>')),d3.select(t+" .graph").datum(e).transition().duration(1e3).call(a).each("start",function(){setTimeout(function(){d3.selectAll(t+" .graph *").each(function(){this.__transition__&&(this.__transition__.duration=1)})},0)}),a})},updateStatControls:function(){var t=scrat.chartCommuData.dateDescs.length;scrat.startViewDate.setStartDate(scrat.chartCommuData.dateDescs[0]),scrat.startViewDate.setEndDate(scrat.chartCommuData.dateDescs[scrat.chartCommuData.dateDescs.length-1]),scrat.endViewDate.setStartDate(scrat.chartCommuData.dateDescs[0]),scrat.endViewDate.setEndDate(scrat.chartCommuData.dateDescs[scrat.chartCommuData.dateDescs.length-1]),$("#stat-controls .btn-cnt span").show(),500>t&&$("#stat-controls .btn-cnt .twoyear").hide(),250>t&&$("#stat-controls .btn-cnt .year").hide(),120>t&&$("#stat-controls .btn-cnt .sixmonth").hide(),60>t&&$("#stat-controls .btn-cnt .threemonth").hide(),20>t&&$("#stat-controls .btn-cnt .month").hide()},refreshSliderExtent:function(t,e){t=parseInt(t),e&&(e=parseInt(e));var a,r=scrat.chartCommuData.dateIDs.length,n=-1,i=-1;for(e||(i=r-1),a=0;r>a;a++)-1===n&&scrat.chartCommuData.dateIDs[a]>=t&&(n=a),-1===i&&scrat.chartCommuData.dateIDs[a]>=e&&(i=a);scrat.chartCommuData.lastExtentTOEnd=[r-i,r-n]},sliderPickerChg:function(){var t={parts:["yyyy","mm","dd"],separators:["","","",""]},e=parseInt(scrat.startViewDate.getFormattedDate(t)),a=parseInt(scrat.endViewDate.getFormattedDate(t));return e>=a?!1:(scrat.utility.refreshSliderExtent(e,a),!0)},sliderBtnClick:function(t){if(!$(t).hasClass("disable")){var e,a;if($(t).hasClass("glyphicon")){var r=$(t).hasClass("glyphicon-backward");e=scrat.chartCommuData.lastExtentTOEnd[1]-scrat.chartCommuData.lastExtentTOEnd[0],r&&(e=0-e),a=[scrat.chartCommuData.lastExtentTOEnd[0]-e,scrat.chartCommuData.lastExtentTOEnd[1]-e],a[0]=Math.max(a[0],1),a[1]=Math.min(a[1],scrat.chartCommuData.dateIDs.length),scrat.chartCommuData.lastExtentTOEnd=a}else{if($("#stat-controls .btn-cnt span").removeClass("selected"),$(t).addClass("selected"),$(t).hasClass("month"))e=21;else if($(t).hasClass("threemonth"))e=61;else if($(t).hasClass("sixmonth"))e=121;else if($(t).hasClass("year"))e=251;else if($(t).hasClass("twoyear"))e=501;else{if($(t).hasClass("real"))return void scrat.utility.refreshSliderExtent(scrat.realStartDateID);e=scrat.chartCommuData.dateIDs.length}scrat.chartCommuData.lastExtentTOEnd[0]=1,scrat.chartCommuData.lastExtentTOEnd[1]=Math.min(e,scrat.chartCommuData.dateIDs.length)}}},addTipItem:function(t){var e=$('<div class="tip-item"><img src="'+(t.avatar||scrat.stockEnums.defaultProfileImg)+'"/><div class="clear"></div><div class="txt">'+t.score+"</div></div>");e[0].data_uid=t.uid,e[0].data_score=t.score,$("#tip-cnt .details").append(e),scrat.utility.bindTooltip(e,"打赏者："+t.username),e.click(function(){window.open("/user/home?uid="+this.data_uid)})},addorUpdateTipsInfo:function(t){var e,a,r=$("#tip-cnt .details .tip-item");for(e=0,a=r.length;a>e;e++)if(r[e].data_uid===scrat.navPara.userProfile.uid)return r[e].data_score+=t,$(r[e]).find(".txt").text(r[e].data_score),!1;return scrat.utility.addTipItem({score:t,uid:scrat.navPara.userProfile.uid,username:scrat.navPara.userProfile.username,avatar:scrat.navPara.userProfile.avatar}),!0},updateTipsSummary:function(t,e,a){var r=$("#tip-cnt .summary");r[0].data_modal&&(t+=r[0].data_modal[0],e+=r[0].data_modal[1]),$("#tip-cnt .summary").text("已有"+t+"人打赏了这个"+a+e+"果仁币:"),$("#tip-cnt .summary")[0].data_modal=[t,e]},getMaxWithdrawFromObjArr:function(t){var e,a,r=0,n=t.values.length,i=t.values[r].yOrigin,s=r,c=[],o=[],u=[];for(e=r;n>e;e++)t.values[e].yOrigin>i&&(i=t.values[e].yOrigin,s=e),c[e]=i,o[e]=s,u[e]=(t.values[e].yOrigin+1)/(c[e]+1);for(a=u[r],e=r;n>e;e++)u[e]<=a&&(a=u[e],s=e);return{maxWithdraw:1-a,start:t.values[o[s]].xIdx,end:t.values[s].xIdx}},getMaxWithdraw:function(t,e,a){var r,n,i=t[e],s=e,c=[],o=[],u=[];for(r=e;a>=r;r++)t[r]>i&&(i=t[r],s=r),c[r]=i,o[r]=s,u[r]=(t[r]+1)/(c[r]+1);for(n=u[e],r=e;a>=r;r++)u[r]<=n&&(n=u[r],s=r);return{maxWithdraw:1-n,start:o[s],end:s}},sortArrBy:function(t,e,a,r){var n,i,s,c,o,u,l,d;if(a===scrat.stockEnums.sortStatus.NORMAL)return t;for(c=[],u=[],r&&(l=r.tag,d=r.values),s=0;s<t.length;s++)o=t[s],l&&-1!==d.indexOf(o[l])?u.push(o):c.push(o);return c.sort(function(t,r){return n=t[e],i=r[e],n==i?0:((isNaN(n)===!1&&isNaN(i)===!1||isNaN(n)&&n&&-1!==n.indexOf("%"))&&(n=parseFloat(n),i=parseFloat(i)),a===scrat.stockEnums.sortStatus.ASCEND?n>i?1:-1:i>n?1:-1)}),c.concat(u)},removePopup:function(){var t=scrat.passageView;t&&(t[0]&&t[0].data_func&&t[0].data_func(),t.hide(),scrat.passageView=null),$(scrat.Enums.DEFAULT_POPUP_MASK_ID).hide()},alertError:function(t,e){var a=$("#alertWindow"),r=a.find(".btn"),n=a.find(".btn.cancel");a.css("top",$("body").scrollTop()+200),a.find(".msg:first").text("").append($("<p>"+t+"</p>")),r.unbind().click(function(){if($(this).hasClass("confirm")){var t=$(this)[0].data_confirmFunc;t&&t(!0),scrat.utility.removePopup()}else scrat.utility.removePopup()}),r.text("ok"),r.removeClass("confirm"),n.remove(),"info"===e?(a.find(">div:eq(0)").text("温馨提示"),a.find(">div:eq(2)").hide()):"confirm"===e?(r.text("确认继续"),r.addClass("confirm"),n=$('<div class="btn cancel">取消</div>'),a.append(n),n.click(function(){scrat.utility.removePopup()}),a.find(">div:eq(0)").text("确认信息"),a.find(">div:eq(2)").hide()):(a.find(">div:eq(0)").text("错误信息"),a.find(">div:eq(2)").show()),a.css("margin-left",-1*a.outerWidth()/2),scrat.utility.addPopup(a)},ajaxDispatch:function(t,e,a,r,n,i){var s={type:t,url:encodeURI(e),dataType:"JSON",cache:!1};if("POST"===t&&r){r.hasOwnProperty("async")&&(s.async=!1,delete r.async);var c=JSON.stringify(r);s.data=c,s.processData=!1}scrat.serverPending++,a&&(scrat.utility.loadingIconShow(),scrat.loadingIconCnt++),$.ajax(s).always(function(t){var s="";if(t.status>=500)return void window.location.reload();if(scrat.debugMode&&console.log("got response from server, url:"+e+", before callback, current pending commands: "+scrat.serverPending),n)if(i||scrat.utility.checkResponseOK(t))n(t);else{var c=t.data?t.data.toString():"";403===t.status?scrat.utility.alertError(c?c:"用户已登出，请刷新页面并重试"):"need_captcha"===t.status?(scrat.captchaPara={url:e,data:r,callback:n},scrat.utility.ajaxDispatch("POST","/captcha/create",!1,{api:e},function(t){scrat.utility.renderCaptchaWin(t.data.url,c)})):("need_confirm"===t.status&&(s="confirm"),"info"===t.status&&(s="info"),scrat.utility.alertError(c?c:"返回数据失败",s),t.data||scrat.utility.ajaxDispatch("POST","/feedback",!1,{level:"error",sys_msg:"服务器返回数据失败"}))}scrat.serverPending--,a&&(scrat.loadingIconCnt--,0===scrat.loadingIconCnt&&scrat.utility.loadingIconHide()),console.log(scrat.debugMode?"got response from server, url:"+e+" current pending commands: "+scrat.serverPending:"got response from server current pending commands: "+scrat.serverPending)}),scrat.debugMode&&console.log("CommandSent:  url: "+e+(r?"  data: "+c:"")+" current pending commands: "+scrat.serverPending)},renderCaptchaWin:function(t,e){$("#captchaWindow").remove();var a=$('<div id="captchaWindow"><div class="title">验证码输入提示</div><span class="glyphicon glyphicon-remove"></span><p>'+e+'</p><img src="'+t+'"><a>看不清?</a><div class="clear"></div><input class="captcha-input" type="text"><button type="button" class="btn btn-default submitBtn" >确定</button></div>'),r=function(){scrat.utility.ajaxDispatch("POST","/captcha/validate",!1,{captcha:a.find(".captcha-input").val()},function(t){scrat.utility.checkResponseOK(t)?(scrat.utility.removePopup(),scrat.utility.ajaxDispatch("POST",scrat.captchaPara.url,!0,scrat.captchaPara.data,scrat.captchaPara.callback)):scrat.utility.ajaxDispatch("POST","/captcha/create",!1,{api:scrat.captchaPara.url},function(t){a.find("img")[0].src=t.data.url,a.find(".captcha-input").val("")})},!0)};scrat.utility.addPopup(a.css(scrat.utility.getGlobalOffset(($(window).height()-400)/2,($(window).width()-300)/2))),a.find("img, a").click(function(){scrat.utility.ajaxDispatch("POST","/captcha/create",!1,{api:scrat.captchaPara.url},function(t){a.find("img")[0].src=t.data.url})}),a.find(".glyphicon-remove").click(function(){scrat.utility.removePopup()}),a.find("button").click(r),a.keydown(function(t){t.stopPropagation(),13===t.keyCode&&r()})},loadingIconShow:function(){var t=$("body");$("#loadingMask img").css({top:t.scrollTop()+300,left:t.width()/2-10}),$("#loadingMask").css("display","block").height(Math.max(t.height(),$(window).height())),scrat.toggleLoadingMsg&&($("#loadingMsg").css({top:t.scrollTop()+280,left:t.width()/2-150,display:"block"}),scrat.toggleLoadingMsg=!1)},loadingIconHide:function(){$("#loadingMask").css("display","none"),$("#loadingMsg").css("display","none")},preloadimages:function(t,e){var a,r=[];for(t="object"!=typeof t?[t]:t,a=0;a<t.length;a++)r[a]=new Image,r[a].src=e+t[a]},imageUploadCallbck:function(t){var e=this;return t[0].size>10485760?void alert("图片需不超过10M，请换一个图片上传"):void lrz(t[0],{width:1600,quality:1}).then(function(a){var r={type:"jpg"},n=a.base64.indexOf("base64");r.data=a.base64.substr(n+7),scrat.utility.ajaxDispatch("POST","/file/upload",!0,r,function(a){$(e).data("summernote").invoke("editor.insertImage",a.data.url,t[0].name)})})},addAttachItem:function(t,e,a){var r=$('<div class="upload-item"><span class="name">'+t+'</span><span class="glyphicon glyphicon-remove"></span></div>');a&&a.noDel?r.find("span.glyphicon-remove").remove():r.find(".glyphicon").click(function(){$(this).parent().remove()}),r[0].data_url=e,r[0].data_name=t,$(".uploaded-cnt").append(r)},uploaderBinding:function(t,e){var a=!1,r=function(){var e,r=this.files[0].name,s={name:r},c="/file/upload";if(this.files&&0!==this.files.length){if($("#"+t).hasClass("derived")&&(s.derived=!0,a=!0,c="/file/upload"),e=a?scrat.globalConst.derivedDataFileUploadLimit:scrat.globalConst.fileUploadLimit,this.files[0].size>e)return void scrat.utility.alertError("请上传不大于"+e+"M的附件");$("#"+t).attr("name",r),$.ajaxFileUpload({url:c,type:"post",data:s,secureuri:!1,name:r,fileElementId:t,dataType:"json",success:i,error:function(t){scrat.utility.loadingIconHide(),scrat.utility.alertError(t.data,t.status)}}),scrat.utility.loadingIconShow(),n()}},n=function(){$("#"+t).unbind(),$("#"+t).change(function(){$("#generalTooltip").hide(),r.call(this)})},i=function(r){scrat.utility.loadingIconHide(),scrat.utility.checkResponseData(r)?(scrat.utility.addAttachItem($("#"+t).attr("name"),r.data.url,a?{noDel:!0}:null),e&&e()):scrat.utility.alertError(r.data,r.status)};n()},getOperatorType:function(t){var e=[scrat.Enums.MeasFilterType.GT,scrat.Enums.MeasFilterType.LT,scrat.Enums.MeasFilterType.VALUE_BETWEEN,scrat.Enums.MeasFilterType.EQ],a=[scrat.Enums.MeasFilterType.TOP,scrat.Enums.MeasFilterType.BOTTOM,scrat.Enums.MeasFilterType.RANGE],r=[scrat.Enums.MeasFilterType.TOPPER,scrat.Enums.MeasFilterType.BOTTOMPER,scrat.Enums.MeasFilterType.RANGEPER];return-1!==e.indexOf(t)?scrat.Enums.MeasFilterCategory.VALUE:-1!==a.indexOf(t)?scrat.Enums.MeasFilterCategory.RANK:-1!==r.indexOf(t)?scrat.Enums.MeasFilterCategory.RANKPER:void 0},getRelativePath:function(t){if(""!==t){var e=t.split("//"),a=e[1].indexOf("/");return e[1].substring(a)}return t},getLocalHrefPara:function(t){var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),a=window.location.href.match(e);return null!=a?unescape(decodeURI(a[2])):null},getURLPara:function(t,e){var a,r=new RegExp("(^|&)"+t+"=([^&]*)(&|$)");return a=e?e.search.substr(1).match(r):window.location.search.substr(1).match(r),null!=a?unescape(decodeURI(a[2])):null},appendURLPara:function(t,e,a){if("#"===t.charAt(t.length-1)&&(t=t.substr(0,t.length-1)),-1!==t.indexOf(e)){var r,n=new RegExp("("+e+"=).*?(&)");return"&"==t.charAt(t.length-1)==0&&(t+="&"),r=t.replace(n,"$1"+a+"$2"),r.substr(0,r.length-1)}return-1===t.indexOf("?")?t+"?"+e+"="+a:t+"&"+e+"="+a},delURLPara:function(t,e){if(!t||-1===t.indexOf("?"))return t;var a,r,n,i,s,c=t.split("?"),o="";a=c[0],r=c[1].split("&");for(var u=0;u<r.length;u++)n=r[u].split("="),i=n[0],s=n[1],i!==e&&(o+="&"+i+"="+s);return 0===o.length?a:(o=o.substring(1,o.length),a+"?"+o)},setCookie:function(t,e,a){var r=new Date,n=22-r.getHours(),i=60-r.getMinutes();0===a?(n=0>n?0:n,r.setTime(r.getTime()+3600*n*1e3+i)):(a=a||1,r.setDate(r.getDate()+a)),document.cookie=t+"="+escape(e)+(null===a?"":";expires="+r.toGMTString())+";path=/"},getCookie:function(t){var e,a,r,n,i;if(document.cookie.length>0){e=document.cookie.split(";");for(var s=0;s<e.length;s++)if(a=e[s].trim(),i=a.split("="),r=i[0],n=i[1],r===t)return unescape(n)}return""},clearCookie:function(t){scrat.utility.setCookie(t,"empty",-1)},translateTag:function(t){return"share"===t?"[知识共享]":"strategy"===t?"[策略评论]":"usage"===t?"[使用问题]":"activity"===t?"[活动]":""},isOperatorRange:function(t){var e=[scrat.Enums.MeasFilterType.VALUE_BETWEEN,scrat.Enums.MeasFilterType.RANGE,scrat.Enums.MeasFilterType.RANGEPER];return-1!==e.indexOf(t)},isBelowIE9:function(){var t=navigator.appName,e=navigator.appVersion,a=e.split(";");if(a.length<=2)return!1;var r=a[1].replace(/[ ]/g,""),n=["MSIE5.0","MSIE6.0","MSIE7.0","MSIE8.0","MSIE9.0"];return Array.prototype.indexOf?"Microsoft Internet Explorer"===t&&-1!==n.indexOf(r)?!0:void 0:!0},scrollTop:function(){return Math.max(document.body.scrollTop,document.documentElement.scrollTop)},documentHeight:function(){return Math.max(document.body.scrollHeight,document.documentElement.scrollHeight)},windowHeight:function(){return"CSS1Compat"==document.compatMode?document.documentElement.clientHeight:document.body.clientHeight},windowWidth:function(){return"CSS1Compat"==document.compatMode?document.documentElement.clientWidth:document.body.clientWidth},showLogin:function(t){scrat.utility.isMobile()?window.location.href="/user/login":($("#loginPopCnt").modal("show"),scrat.navPara.urlJump=t)},checkWx:function(){var t=1;return wx.checkJsApi({jsApiList:["onMenuShareTimeline","onMenuShareAppMessage"],success:function(e){(e.checkResult.onMenuShareTimeline===!1||e.checkResult.onMenuShareAppMessage===!1)&&(t=-1,scrat.utility.addFadeoutPopup("#fadeout-tips","该浏览器不支持微信分享操作",1500))}}),t},setWxCfg:function(){var t=window.location.href.split("#")[0];t=encodeURIComponent(t),scrat.utility.ajaxDispatch("GET","/wechat/jsconfig?url="+t,!1,null,function(t){var e={debug:!1,appId:t.data.appid,timestamp:t.data.timestamp,nonceStr:t.data.noncestr,signature:t.data.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage","showOptionMenu","showMenuItems"]};wx.config(e),wx.ready(function(){scrat.utility.shareWx()})})},shareWx:function(){var t,e,a,r;t="使用果仁网，领先大A股90%的投资者",e=scrat.stockEnums.serverUrl+"/stock/adv?i=",a=scrat.stockEnums.serverUrl+"/static/images/m_share_logo.png",r="通过大数据回测分析，锁定盈利，轻松穿越牛熊",scrat.navPara.userProfile&&(e+=scrat.navPara.userProfile.uid),wx.onMenuShareTimeline({title:t,link:e,imgUrl:a,success:function(){},cancel:function(){}}),wx.onMenuShareAppMessage({title:t,link:e,imgUrl:a,desc:r,type:"link",dataUrl:"",success:function(){},cancel:function(){}}),wx.showOptionMenu(),wx.showMenuItems({menuList:["menuItem:share:appMessage","menuItem:share:timeline"]})},getNextStep:function(t){var e;return e=t.indexOf("()"),-1===e&&(e=t.indexOf("(,"),-1===e&&(e=t.indexOf(",,"),-1===e&&(e=t.indexOf(",)"),-1===e)))?t.length:e+1},insertText:function(t,e){if(document.selection){var a=document.selection.createRange();a.text=e}else if("number"==typeof t.selectionStart&&"number"==typeof t.selectionEnd){var r=t.selectionStart,n=t.selectionEnd,i=r,s=t.value;t.value=s.substring(0,r)+e+s.substring(n,s.length),i+=scrat.utility.getNextStep(e+s.substring(n,s.length)),t.selectionStart=t.selectionEnd=i}else t.value+=e;t.focus()},judgeDate:function(t,e,a){var r,n,i,s,c,o,u="-",l=new Date,d=!1;if(!t)return!1;switch(-1===t.indexOf(u)&&(u="/"),r=t.split(u),n=parseInt(r.join("")),i=l.getMonth()+1,s=l.getDate(),c=a&&a.noYear?"":l.getFullYear(),c+=(10>i?"0":"")+i+(10>s?"0":"")+s,o=parseInt(c),e){case"now":d=o===n;break;case"expire":d=o>n;break;case"ge":d=o>=n}return d},checkNumberIsInt:function(t){return isNaN(t)?!1:parseFloat(t)-parseInt(t)===0},bindServiceClick:function(){var t=$("#buy-service"),e=t.find(".service-info"),a=t.find(".service-cnt");e.find(".btn.ok").click(function(){e.hide(),a.show()}),e.find(".btn.cancel").click(function(){t.modal("hide")}),t.find(".submit").click(function(){scrat.utility.buyService()}),t.on("hidden.bs.modal",function(){scrat.buyService_checkTimer&&(clearTimeout(scrat.buyService_checkTimer),scrat.buyService_checkTimer=null)}),t.find(".period select").change(function(){scrat.utility.setServiceSelectChange(!0)}),t.find("select.coupon-list").change(function(){scrat.utility.setServiceSelectChange()})},setCouponList:function(t){var e,a,r,n,i,s=$("#buy-service"),c=s.find(".coupon-list"),o=c.val(),u=!1,l=0,d=!1;for(c.empty(),n=0;n<scrat.coupons_ids.length;n++)a=scrat.coupons_ids[n],r=scrat.coupons[a],i=r.condition,(!i||i&&t>=i)&&(e=scrat.stockEnums.couponScopeInfo[r.scope]||"全品类",c.append($('<option value="'+a+'">'+r.discount_desc+"-"+e+"</option>")),o&&a===parseInt(o)&&(u=!0),l++);return 0===l?s.find(".coupon-discount").addClass("hide"):(s.find(".coupon-discount").removeClass("hide"),c.append($('<option value="">不使用优惠券</option>')),u&&c.val(o),d=!0),d
},setServiceSelectChange:function(t){var e,a,r,n,i,s,c=$("#buy-service"),o=c.find(".period select").val(),u=scrat.buyService_balanceNum,l=scrat.buyService_price,d=o*l,p=d;c.find(".cnt-body .total").text((d/10).toFixed(2)+"元"),t&&scrat.utility.setCouponList(d/10),e=scrat.coupons[c.find("select.coupon-list").val()],e?(a=e.discount,r=e.condition,n=e.quantity_limit,a>=0?(i=(a-1)*p,n&&o>n&&(i=(a-1)*l*n)):i=10*a,p+=i,c.find(".coupon-price .number").text((0>i?i/10:0).toFixed(2)+"元"),c.find(".coupon-price").removeClass("hide")):(c.find(".coupon-price .number").text(""),c.find(".coupon-price").addClass("hide")),0>=p||0>=u?c.find(".reduce-cnt").addClass("hide"):(s=Math.min(p,u),c.find(".reduce.guorn").text(s),c.find(".reduce.number").text((s/10).toFixed(2)),c.find(".reduce-cnt").removeClass("hide")),p-=u,0>p&&(p=0),c.find(".topay").text((p/10).toFixed(2)+"元"),scrat.buyService_pay=p,scrat.buyService_months=o},checkService:function(t,e){scrat.utility.ajaxDispatch("GET","/service/status?service_type="+t.type,!0,null,function(a){var r,n,i,s,c,o=a.data[0];r=o.service_price,s=t.unit||scrat.stockEnums.ServiceUnits.Month,n=o.service_id,i=o.remain||0,c=o.due_date,t.type===scrat.stockEnums.ServiceTypes.TraderAccount?scrat.utility.showBuyService({type:t.type,reload:t.reload,showCnt:t.showCnt,price:r,unit:s,cfg:t.cfg}):t.type===scrat.stockEnums.ServiceTypes.RealScreen?!n||t.buy||c&&scrat.utility.judgeDate(c,"expire")?scrat.utility.showBuyService({type:t.type,reload:t.reload,showCnt:t.showCnt,price:r,unit:s}):e&&e():t.type===scrat.stockEnums.ServiceTypes.WechatPush?!n&&0===i||t.buy||c&&scrat.utility.judgeDate(c,"expire")?scrat.utility.showBuyService({type:t.type,reload:t.reload,showCnt:t.showCnt,price:r,unit:s}):e&&e():t.type===scrat.stockEnums.ServiceTypes.TraderAccount?!n&&0===i||t.buy||c&&scrat.utility.judgeDate(c,"expire")?scrat.utility.showBuyService({type:t.type,reload:t.reload,showCnt:t.showCnt,price:r,unit:s}):e&&e():t.type===scrat.stockEnums.ServiceTypes.AssetNum&&(!n||t.buy||c&&scrat.utility.judgeDate(c,"expire")?t.buy&&scrat.utility.showBuyService({type:t.type,reload:t.reload,showCnt:t.showCnt,price:r,unit:s}):e&&e())})},showBuyService:function(t){var e=$("#buy-service"),a=t.type,r=t.reload,n=t.showCnt,i=t.price,s=t.unit,c=scrat.stockEnums.Services[a].name,o=scrat.stockEnums.Services[a].couponScope,u=scrat.stockEnums.Services[a].info,l=scrat.stockEnums.Services[a].discount;e.find(".service-info .info").text("").append($("<span>"+u+"</span>")),n?(e.find(".service-info").hide(),e.find(".service-cnt").show()):(e.find(".service-cnt").hide(),e.find(".service-info").show()),a===scrat.stockEnums.ServiceTypes.BuyVip||a===scrat.stockEnums.ServiceTypes.BuySenior?(e.find(".vip-price").hide(),e.find(".name").css("width","44%"),scrat.buyService_eventId=t.eventId):(e.find(".vip-price").show(),e.find(".name").css("width","28%")),scrat.utility.ajaxDispatch("GET","/user/profile",!0,null,function(n){var u,d,p=n.data.level;e.find(".cnt-body .name").text(c),e.find(".cnt-body .price").text((i/10).toFixed(2)+"元/"+s),e.find(".cnt-body span.vip-price").text(((i-l)/10).toFixed(2)+"元/"+s),u=n.data.score,d=i,p===scrat.stockEnums.LevelList.VIP&&(d=i-l),scrat.buyService_price=d,e.find(".cnt-body .total").text((d/10).toFixed(2)+"元"),scrat.buyService_months=1,e.find(".period select").val(scrat.buyService_months),scrat.utility.ajaxDispatch("GET","/payment/coupon",!0,null,function(n){var i,s,c,l,p=n.data.avail,m=e.find(".coupon-list"),f=0,h=d;for(m.empty(),scrat.coupons={},scrat.coupons_ids=[],s=0;s<p.length;s++)i=p[s],-1!==o.indexOf(i.scope)&&scrat.utility.judgeDate(i.start_date,"ge")&&(scrat.coupons[i.coupon_id]={discount:i.discount,quantity_limit:i.quantity_limit,condition:i.condition,scope:i.scope,discount_desc:i.discount_desc},scrat.coupons_ids.push(i.coupon_id),f++);if(scrat.utility.setCouponList(d/10)){{var y=scrat.coupons[m.val()],v=y.discount;y.condition}c=v>=0?(v-1)*h:10*v,h+=c,e.find(".coupon-price .number").text((0>c?c/10:0).toFixed(2)+"元"),e.find(".coupon-price").removeClass("hide")}0>=h||0>=u?e.find(".reduce-cnt").addClass("hide"):(l=Math.min(h,u),e.find(".reduce.guorn").text(l),e.find(".reduce.number").text((l/10).toFixed(2)),e.find(".reduce-cnt").removeClass("hide")),h-=u,0>h&&(h=0),e.find(".topay").text((h/10).toFixed(2)+"元"),e.find(".submit").text("确认付款"),e.find(".submit")[0].cfg=null,t.cfg&&(e.find(".submit")[0].cfg=t.cfg),e.find(".cnt-body").show(),e.find(".cnt-warn").hide(),e.find(".cnt-over").hide(),e.find(".cnt-bottom").show(),e.find(".submit")[0].disabled=!1,e.find("select.coupon-list")[0].disabled=!1,e.find(".period select")[0].disabled=!1,scrat.buyService_pay=h,scrat.buyService_type=a,scrat.buyService_reload=r,scrat.buyService_balanceNum=u,e.modal({backdrop:"static"}),e.modal("show")})})},buyService:function(t){var e,a,r,n=$("#buy-service"),i=0,s=!1,c=!1,o=function(){var e=u(a,!1);scrat.utility.ajaxDispatch("POST",e.api,!0,e,function(){n.modal("hide"),t?setTimeout(t,500):s?!scrat.utility.isMobile()||scrat.buyService_type!==scrat.stockEnums.ServiceTypes.BuySenior&&scrat.buyService_type!==scrat.stockEnums.ServiceTypes.BuyVip?scrat.buyService_type===scrat.stockEnums.ServiceTypes.TraderAccount?window.location.reload():window.location.href="/user/home?page=service":window.location.href="/user/home":scrat.utility.addFadeoutPopup($("#fadeout-tips"),"购买"+scrat.stockEnums.Services[a].name+"成功",1500)})},u=function(t,e){var a={service_type:t},r=n.find(".coupon-list").val(),i=scrat.stockEnums.Services[t].api;return r&&(a.coupon_id=parseInt(r)),scrat.buyService_months&&(a.quantity=parseInt(scrat.buyService_months),a.months=parseInt(scrat.buyService_months)),t===scrat.stockEnums.ServiceTypes.BuyVip||t===scrat.stockEnums.ServiceTypes.BuySenior?(a.event_id=scrat.buyService_eventId,a.auto_renew=1,s=!0):scrat.buyService_type===scrat.stockEnums.ServiceTypes.TraderAccount&&n.find("button.submit")[0].cfg&&(a.account_id=n.find("button.submit")[0].cfg.account_id),a.api=i,e&&(a.command=i),a},l=function(e){scrat.utility.ajaxDispatch("GET","/payment/status?trade_num="+e,!1,null,function(e){var a=e.data;"success"===a.payment_status&&(t?(t(),c=!0):window.location.href=!scrat.utility.isMobile()||scrat.buyService_type!==scrat.stockEnums.ServiceTypes.BuySenior&&scrat.buyService_type!==scrat.stockEnums.ServiceTypes.BuyVip?"/user/home?page=service":"/user/home")}),i===scrat.stockEnums.CheckLimitCnt||c?(clearTimeout(scrat.buyService_checkTimer),scrat.buyService_checkTimer=null,i=0,n.find(".cnt-over").show(),n.find(".cnt-bottom").hide()):(scrat.buyService_checkTimer=setTimeout(function(){l(e)},1e3),i++)};if(e=scrat.buyService_pay,a=scrat.buyService_type,s=scrat.buyService_reload===!0,n.find(".submit")[0].disabled=!0,n.find("select.coupon-list")[0].disabled=!0,n.find(".period select")[0].disabled=!0,0>=e)o();else{var d=u(a,!0),p={},m=n.find(".coupon-list").val();scrat.utility.fromWechat()?(p.amount=e,p.pay_channel="alipay",p.client="mobile",p.postpay_task=d,scrat.utility.ajaxDispatch("POST","/payment/new?fmt=json",!0,p,function(t){if("ok"===t.status){var e=t.data;e&&window.open(e.payment_api+"&service_type="+a+"&quantity="+scrat.buyService_months+(m?"&coupon_id="+m:""),"_self")}})):(n.find(".submit").text("等待付款中"),n.find(".cnt-body").hide(),n.find(".cnt-warn").show(),r=window.open(),p.amount=e,p.pay_channel="alipay",p.client="web",scrat.utility.isMobile()&&(p.client="mobile"),p.postpay_task=d,scrat.utility.ajaxDispatch("POST","/payment/new?fmt=json",!0,p,function(t){var e=t.data;e&&(r.location=e.payment_api,l(e.trade_num))}))}}};
;!function(){scrat.DSUnit=scrat.classDef(scrat.Model,null,{dsUnitView:null}),scrat.DSList=scrat.classDef(scrat.ModelSet,null,{publicModel:null,dsPanelViewer:null,addPrivateModel:function(e){var e=this.reOrgModel(e);this.models.push(e),this.dsPanelViewer.addPrivate(e)},removePrivateModel:function(e){var t,i;for(t=0,i=this.models.length;i>t;t++)if(e===this.models[t].id)return void this.models.splice(t,1)},reOrgModel:function(e){function t(t,i){function n(t){$.each(t,function(n,s){if(s){var a=new scrat.Model({id:s.id,name:s.name,cubeID:e.id,type:i,sel:0});t[n]=a}})}if(t&&t instanceof Array&&0!==t.length)return t instanceof Array&&(t[0]instanceof Array||t[0].content instanceof Array)?void $.each(t,function(e,t){n(t)}):n(t)}return t(e.units.attr,scrat.Enums.UnitType.ATTR),t(e.units.meas,scrat.Enums.UnitType.MEAS),e},updatePrivate:function(e){var t,i,e=this.reOrgModel(e);for(t=0,i=this.models.length;i>t;t++)if(e.id===this.models[t].id){this.models[t]=e,this.dsPanelViewer.updatePrivate(e);break}t===i&&(this.models[t]=e,this.dsPanelViewer.addPrivate(e))},addPublicModel:function(e){var t,i;$.each(e,function(e,n){var s=function(e,s){var a=new scrat.Model({id:s.id,name:s.name,cubeID:n.id,type:i,sel:0});t.push(a)};t=[],i=scrat.Enums.UnitType.ATTR,$.each(n.units.attr,s),i=scrat.Enums.UnitType.MEAS,$.each(n.units.meas,s),n.content=t}),this.publicModel=e},getNameByID:function(e){return scrat.utility.retrieveNameByID(this.publicModel,e)||scrat.utility.retrieveNameByID(this.models,e)}})}();
;!function(){scrat.FilterModel=scrat.classDef(scrat.Model,null,{})}();
;!function(){scrat.SheetDataModel=scrat.classDef(scrat.Model,null,{sheetModel:null,init:function(t){this.superCall(t)},update:function(t){var e,s,a,i,o=[],r=[],h=[],l=[],c=!1;for(a=t.row,e=0,s=a.length;s>e;e++)(scrat.appType!==scrat.Enums.APPType.STOCK||"择时"!==a[e].name)&&(o.push(a[e].id),i=this.sheetModel.getSheetUnitModel(a[e].id),i&&(i.d=a[e].d));for(a=t.col,e=0,s=a.length;s>e;e++)a[e].type===scrat.Enums.UnitType.ATTR?(c=!0,i=this.sheetModel.getSheetUnitModel(a[e].id),i&&(i.d=a[e].d)):(h.push(a[e].name),l.push(a[e].id),i=this.sheetModel.getSheetUnitModel(a[e].id),i&&(i.rng=a[e].rng)),r.push(a[e].id);if(scrat.combine(this,{rowTotalCnt:t.row_size,colTotalCnt:t.col_size,rowUnitIDs:o,colUnitIDs:r,row:t.row,col:t.col,measData:t.meas_data,measNames:h,measIDs:l,attrOnCol:c,colAttEleCnt:Math.floor(t.meas_data.length/h.length)}),this.rowCnt=this.row.length>0?this.row[0].data[0].length:this.measData>0?this.measData[0].length:0,this.colCnt=t.meas_data.length,this.sheetModel.getLayoutType()===scrat.Enums.ViewLayoutType.CHART)this.createGraphBasics();else{var n=scrat.utility.getArrValues(this.row,"data");this.reOrgData=this.reOrgGridData(n,this.measData),this.rowCnt=this.reOrgData.length}},checkMeasEmpty:function(){if(0===this.measData.length)return!0;var t,e;for(t=0,e=this.measData.length;e>t;t++)if(this.measData[t].length>0)return!1;return!0},createGraphBasics:function(){var t,e,s,a,i,o,r,h,l=[],c=[],n=this.measNames.length;for(e=this.row,i=0;i<this.rowCnt;i++){for(s="",o=0,r=this.rowUnitIDs.length;r>o;o++)t=e[o].d.disp,s+=e[o].data[t][i],s+=" ";l.push(s)}for(e=this.col,i=0,r=this.measData.length;r>i;i++)if(i%n===0){for(a="",o=0,h=e.length;h>o;o++)"attr"===e[o].type&&(t=e[o].d.disp,a+=e[o].data[t][i],a+=" ");c.push(a)}this.rowAttDescs=l,this.colAttDescs=c},createABLChartData:function(){var t,e,s,a,i,o,r,h,l,c,n=this.colAttDescs,d=[],u=1,D=this.measNames.length,g=this.colUnitIDs.length-D,m=this.sheetModel.sheetLayout.chart,y=m.style&&m.style.dual_axis&&m.meas_group instanceof Array;for(s=0,i=this.measData.length;i>s;s++){for(t=n[parseInt(s/D)],h=s%D,l=this.sheetModel.getSheetUnitFormat(this.measIDs[h]),c=scrat.utility.parseFormatStr(l).type,(0===g||this.measNames.length>1)&&(t+=this.measNames[h],this.sheetModel.stockPara&&this.sheetModel.stockPara.unifyMeasure&&(t+=scrat.utility.getFormatPostFix1(l))),e=[],this.sheetModel.stockPara&&this.sheetModel.stockPara.scale&&(u=this.sheetModel.stockPara.scale[s]||1),a=0,o=this.measData[s].length;o>a;a++)this.measData[s][a],e[a]={x:this.rowAttDescs[a],y:this.measData[s][a],xIdx:a},this.sheetModel.stockPara&&this.sheetModel.stockPara.unifyMeasure&&(e[a].y=scrat.utility.getDisplayValueWithFormat(e[a].y,c)),e[a].y*=u,this.sheetModel.stockPara&&(this.sheetModel.stockPara.zeroBase||this.sheetModel.stockPara.axisLog||this.sheetModel.stockPara.normalize)&&(e[a].yOrigin=e[a].y),""===this.measData[s][a]?(e[a].y=0/0,e[a].notActive=!0):0!==a&&""!==this.measData[s][a-1]||a!==o-1&&""!==this.measData[s][a+1]||(e[a].singleDot=!0),this.sheetModel.stockPara&&this.sheetModel.stockPara.firstRed&&(e[a].color="bar"===m.type&&0===a?"#f00":"#2776b6");r=this.sheetModel.stockPara&&this.sheetModel.stockPara.firstRed?"line"===m.type&&0===s?"#f00":scrat.utility.getCSSColor(scrat.utility.getDefaultColor(s-("line"===m.type?1:0),i)):this.sheetModel.stockPara&&this.sheetModel.stockPara.baseRed?0===s?"#f00":scrat.utility.getCSSColor(scrat.utility.getDefaultColor(s-1,i)):scrat.utility.getCSSColor(this.sheetModel.stockPara&&this.sheetModel.stockPara.OrigenGreen?scrat.utility.getDefaultColor(s+1,i):this.sheetModel.stockPara&&this.sheetModel.stockPara.firstGreen?0===s?2990626:scrat.utility.getDefaultColor(s-1,i):scrat.utility.getDefaultColor(s,i)),d[s]={key:t,values:e,color:r,fmt:this.sheetModel.stockPara&&this.sheetModel.stockPara.unifyMeasure?".2f":l},y&&(d[s].yAxis=this.sheetModel.getMeasDualAxisIdx(this.colUnitIDs[g+h]),d[s].type="bar"===m.type?1===d[s].yAxis?"bar":"bar":m.type)}if(this.sheetModel.stockPara&&this.sheetModel.stockPara.createDateID){e=[];var f=-1;for(a=0,o=this.measData[0].length;o>a;a++)this.row[0].data[0][a]>=this.sheetModel.stockPara.createDateID&&-1===f&&(f=a),e[a]={x:this.rowAttDescs[a],y:f>=0?this.measData[1][a]:0/0,xIdx:a,yOrigin:this.measData[1][a]},e[a].tooltipY=f>=0?(this.measData[1][a]+1)/(this.measData[1][f]+1)-1:0/0;f>=0&&(this.sheetModel.stockPara.createDateID=this.row[0].data[0][f],d.push({key:"创建后收益",values:e,color:"#2175ee",fmt:".2%",width:4}))}this.ABLGraphDP=d},createDotChartData:function(t){var e,s,a,i,o,r,h,l,c,n,d=[],u=this.measNames.length,D=this.sheetModel.sheetLayout.chart.colorby,g=this.colAttEleCnt,m=t.xMetricIdx,y=t.yMetricIdx,f=t.zMetricIdx,p="",M="",w=[],C=[],k={};for(s=this.col,o=0;g>o;o++){for(a="",c="",n="",r=0,h=s.length;h>r;r++)"attr"===s[r].type&&(e=s[r].d.disp,a+=s[r].data[e][o*u],a+=" ",D&&D===s[r].id&&(c+=s[r].data[s[r].d.id][o*u],n+=s[r].data[e][o*u]));for(d[o]={key:a,values:[]},l=0;l<this.rowCnt;l++){for(i={shape:"circle",name:this.rowAttDescs[l],seriesName:a,alpha:.5},r=0;u>r;r++)r===m&&(i.x=this.measData[o*u+r][l]),r===y&&(i.y=this.measData[o*u+r][l]),r===f&&(i.size=this.measData[o*u+r][l]);if(f>=u&&(i.size=10),D){for(p=c,M=n,r=0,h=this.row.length;h>r;r++)D===this.row[r].id&&(p+=this.row[r].data[this.row[r].d.id][l],M+=this.row[r].data[this.row[r].d.disp][l]);void 0===k[p]&&(k[p]=scrat.utility.getCSSColor(scrat.GlobalColors10[w.length%10]),w.push(p),C.push({key:M,color:k[p]})),i.color=k[p]}else i.color=scrat.utility.getCSSColor(scrat.GlobalColors10[0]);""!==i.x&&""!==i.y&&""!==i.size&&(d[o].values[l]=i)}}this.dotGraphDP=d,this.dotColorBy=C},combineMapData:function(t,e,s){var a,i,o,r,h,l,c,n=this.measNames.length,d=this.colAttEleCnt,u=this.row[t].d.id,D=this.row[t].d.disp;for(r=0;r<this.rowCnt;r++)for(l=this.row[t].data[u][r],c=this.row[t].data[D][r],a=0,o=s.length;o>a;a++)if(h=s[a],h.id==l){for(void 0===h.properties.colors&&(h.properties.colors=[]),i=0;d>i;i++)h.properties.colors[i]=this.measData[i*n+e][r];h.properties.chnName=c}},reOrgGridData:function(t,e){var s=[],a=this.row.length;return $.each(t,function(t,e){$.each(e,function(e,a){$.each(a,function(a,i){void 0===s[a]&&(s[a]=[]),void 0===s[a][t]&&(s[a][t]=[]),s[a][t][e]=i})})}),$.each(e,function(t,e){$.each(e,function(e,i){void 0===s[e]&&(s[e]=[]),s[e][t+a]=i})}),s},fillinChunkData:function(t){var e=scrat.utility.getArrValues(t.row,"data"),s=this.reOrgGridData(e,t.meas_data);return this.rowCnt+=s.length,this.reOrgData=this.reOrgData.concat(s),s}})}();
;!function(){scrat.SheetLayoutModel=scrat.classDef(scrat.Model,null,{switchChartType:function(){this.superCall(props)}})}();
;!function(){scrat.SheetDimentionModel=scrat.classDef(scrat.Model,null,{type:"",getUnitHierarchy:function(t){var e,s,i;for(e=0,s=this.content.length;s>e;e++){if(this.content[e].id===t)return this.content[e];if(this.content[e].group instanceof Array&&(i=scrat.utility.getArrValues(this.content[e].group,"id"),-1!==i.indexOf(t)))return this.content[e]}return null},getUnitGroup:function(t){var e,s,i;for(e=0,s=this.content.length;s>e;e++){if(this.content[e].id===t)return this.content[e];if(this.content[e].group instanceof Array&&(i=scrat.utility.getArrValues(this.content[e].group,"id"),-1!==i.indexOf(t)))return this.content[e]}return null}}),scrat.SheetDimentionsModel=scrat.classDef(scrat.ModelSet,null,{models:null,getUnitHierarchy:function(t){var e,s;for(e=0,s=this.models.length;s>e;e++){var i=this.models[e].getUnitHierarchy(t);if(null!==i)return this.models[e]}return null},getUnitGroupID:function(t){var e,s;for(e=0,s=this.models.length;s>e;e++){var i=this.models[e].getUnitGroup(t);if(null!==i)return i.id}return null}}),scrat.SheetModel=scrat.classDef(scrat.Model,null,{init:function(t){this.superCall(t),this.sheetUnits={},this.filterModel={},this.clientProp={},this.updated=!1},update:function(t,e){if(this.updated=!0,t&&e){var s,i;for(var n in t){var r=t[n];switch(n){case"sheet_units":for(var h in r){var a=new scrat.SheetUnitModel(r[h]);this.sheetUnits[h]=a,void 0!==a.filter&&(this.filterModel[a.id]=a.filter)}break;case"context":this.used=r.recently_used||[];var o=[];for(r=r.hierarchy,s=0,i=r.length;i>s;s++)o.push(new scrat.SheetDimentionModel({name:r[s].name,content:r[s].content,index:s}));this.dimentionsModel=new scrat.SheetDimentionsModel({models:o});break;case"sheet_name":this.name=r;break;case"layout":this.sheetLayout=new scrat.SheetLayoutModel({format:r.format||{},grid:r.grid||{},chart:r.chart||{},layout_type:r.layout_type||"grid"});break;case"primary":this.primary=r;break;case"params":this.params=r;break;case"filter":this.filterModel.cube=r.cube;break;case"stockPara":this.stockPara=r.stockPara}}return this.sheetData=new scrat.SheetDataModel({sheetModel:this}),this.sheetData.update(e),this.fakeSheetUnits(),this}},updateLayout:function(t){t.layout_type&&(this.sheetLayout=t)},fakeSheetUnits:function(){var t,e,s=this,i=function(i){for(t=0,e=i.length;e>t;t++)if(void 0===s.sheetUnits[i[t].id]&&"择时"!==i[t].name){var n=new scrat.SheetUnitModel(i[t]);s.sheetUnits[i[t].id]=n}};i(this.sheetData.row),i(this.sheetData.col)},getSheetUnitModel:function(t){return this.sheetUnits[t]},getSheetUnitFormat:function(t){var e=this.getSheetUnitModel(t);return e&&e.getType()===scrat.Enums.UnitType.MEAS?e.fmt:null},replaceNameWithID:function(t){for(key in this.sheetUnits)t=this.sheetUnits[key].replaceNameWithID(t);return t},replaceIDWithName:function(t){for(key in this.sheetUnits)t=this.sheetUnits[key].replaceIDWithName(t);return t},getLayoutType:function(){return this.sheetLayout&&this.sheetLayout.layout_type?this.sheetLayout.layout_type:null},getMeasDualAxisIdx:function(t){var e=this.sheetLayout.chart.meas_group;if(e instanceof Array){if(-1!==e[0].indexOf(t))return 1;if(-1!==e[1].indexOf(t))return 2}return-1},getMetricNames:function(){var t=[];if(this.sheetData){var e=this.sheetData.rowUnitIDs.concat(this.sheetData.colUnitIDs);for(key in this.sheetUnits)-1!==e.indexOf(this.sheetUnits[key].id)&&t.push(this.sheetUnits[key].name)}return t},getParamNames:function(t){var e,s,i=[];for(e=0,s=(this.params||[]).length;s>e;e++)i.push((t||"")+this.params[e].name);return i},isEmpty:function(){return _.isEmpty(this.sheetUnits)||_.isEmpty(this.sheetData.row)&&_.isEmpty(this.sheetData.col)}}),scrat.SheetList=scrat.classDef(scrat.Model,null,{sheetIDs:[],models:{},currentSheetID:"",addSheet:function(t,e,s){-1===this.sheetIDs.indexOf(t)&&(this.sheetIDs.push(t),this.models[t]=new scrat.SheetModel({id:t,name:e,updated:s}))},deleteSheet:function(t){-1!==this.sheetIDs.indexOf(t)&&(this.sheetIDs.splice(this.sheetIDs.indexOf(t),1),delete this.models[t])},getNext:function(t){var e=this.sheetIDs.indexOf(t);return-1===e||1===this.sheetIDs.length?-1:e===this.sheetIDs.length-1?this.sheetIDs[e-1]:this.sheetIDs[e+1]},addAndSetCurrentSheet:function(t,e){this.addSheet(t,e,!0),this.currentSheetID=t,scrat.sheetPanelInst.setModel(this.getCurrentSheetModel())},addOrUpdateSheetModel:function(t,e,s){var i=this.models[this.currentSheetID];i||(this.sheetIDs.push(this.currentSheetID),this.models[this.currentSheetID]=new scrat.SheetModel,i=this.models[this.currentSheetID]),i.update(t,e),s&&(i.highlightUnit=s)},getCurrentSheetModel:function(){return this.models[this.currentSheetID]},getSheetModelByID:function(t){return this.models[t]},createDefaultSheetName:function(){var t,e,s,i=this,n="工作页",r=n.length,h=1;for(s in i.models)e=i.models[s].name.indexOf(n),0===e&&(t=parseInt(i.models[s].name.slice(r)),t>=h&&(h=t+1));return n+h}})}();
;!function(){scrat.SheetUnitModel=scrat.classDef(scrat.Model,null,{replaceNameWithID:function(e){if(-1!==e.indexOf(this.name)){var t=new RegExp(this.name,"g");e=e.replace(t,this.id)}return e},replaceIDWithName:function(e){if(-1!==e.indexOf(this.id)){var t=new RegExp(this.id,"g");e=e.replace(t,this.name)}return e},getType:function(){return"attr"===this.type?scrat.Enums.UnitType.ATTR:-1!==this.type.indexOf("meas")||"derived"===this.type?scrat.Enums.UnitType.MEAS:scrat.Enums.UnitType.UNKNOWN}}),scrat.SheetParaModel=scrat.classDef(scrat.Model,null,{})}();
;!function(){function t(t,i,e){var n='<div class="dsUnitCnt"><div class="icon dsUnitIcon'+(i.type===scrat.Enums.UnitType.ATTR?"Attr":"Meas")+'"></div><div class="dsUnitTxt"></div></div>',s=new scrat.View({$el:$(n)});return s.model=i,s.$el.find(".dsUnitTxt").text(i.name).prop("originalStr",i.name),i.dsUnitView=s,s.listenTo("click",function(t){(scrat.utility.isMobile()||"ClickMethodSingle"===scrat.ClickMethod)&&e(t)}),s.listenTo("dblclick",e),t.append(s.$el),scrat.utility.handleTruncationTxt(s.$el.find(".dsUnitTxt")),s}scrat.DatasetPanel=scrat.classDef(scrat.View,null,{currentDS:null,events:{"click #publicDataTitle":"titleClick"},doLayout:function(t,i){this.superCall(t,i),$(this.ID+" .dsPanelCnt").css({"max-height":i-30,width:t-10});var e=$(this.ID+" .dsTitleCnt .txt").css({"max-width":t-75}),n=$(this.ID+" .dsGroupTitleCnt .txt").css({"max-width":t-60}),s=$(this.ID+" .dsUnitCnt .dsUnitTxt").css({"max-width":t-66}),a=function(t){for(var i=0,e=t.length;e>i;i++)scrat.utility.handleTruncationTxt(t[i])};a(e),a(n),a(s)},init:function(t){var i;this.superCall(t),$(this.ID).resizable({handles:"e",distance:2,delay:150,maxWidth:400,minWidth:120}),i=this.ID,$(this.ID+" .uploadCnt").mouseenter(function(){$(i+" .uploadBtn").addClass("highlight"),document.body.style.cursor="pointer"}).mouseleave(function(){$(i+" .uploadBtn").removeClass("highlight"),document.body.style.cursor="default"})},updatePrimary:function(){var t,i=$(this.ID+" .dsTitleCnt, .dsGroupTitleCnt"),e=i.length,n=scrat.sheetList.getCurrentSheetModel(),s=n.primary?n.primary.cube_id:null;for(t=0;e>t;t++)i[t].data_id===s?$(i[t]).addClass("highlight"):$(i[t]).removeClass("highlight");return this},addPublic:function(i){var e=this,n=this.$el.find(".dsTitleCnt").first(),s=this.$el.find(".dsCnt").first(),a=n.find(".txt");n.click(function(){$(this).next().toggle(),$(this).next().next().toggle(),$(this).find(".icon").toggleClass("fold")}),a.prop("originalStr",a.text()),$.each(i,function(i,n){var a=$('<div class="dsGroupTitleCnt"><div class="icon"></div><div class="txt">'+n.name+"</div></div>"),d=$('<div class="dsGroupCnt"></div>');a.click(function(){$(this).next().toggle(),$(this).find(".icon").toggleClass("unfold")}),s.append(a).append(d),a[0].data_id=n.id,scrat.utility.handleTruncationTxt(a.find(".txt").prop("originalStr",n.name)),$.each(n.content,function(i,n){t.call(e,d,n,_.bind(e.unitBtndbClick,e)),d.append('<div class="clear"></div>')}),d.toggle()})},addPrivate:function(i,e){function n(i){function e(i){$.each(i,function(i,e){if(e){var n=t.call(s,d,e,_.bind(s.unitBtndbClick,s));n.$el.find(".icon").click(function(t){t.stopPropagation();var i=$("#unitTypeEditor"),e=$(this).offset();i.find("div").unbind(),n.model.type===scrat.Enums.UnitType.ATTR?(i.find(".attr").addClass("highlight"),i.find(".meas").removeClass("highlight")):(i.find(".attr").removeClass("highlight"),i.find(".meas").addClass("highlight")),i.find(".attrCnt, .measCnt").click(function(){s.unitTypeChange(n.model,this.className.substr(0,4)),scrat.utility.removePopup()}),scrat.utility.addPopup(i.css(scrat.utility.getGlobalOffset(e.top-30,e.left-9)))})}})}i&&i instanceof Array&&0!==i.length&&(i instanceof Array&&(i[0]instanceof Array||i[0].content instanceof Array)?$.each(i,function(t,i){e(i instanceof Array?i:i.content)}):e(i))}var s=this,a=$('<div class="dsTitleCnt"> <div class="icon"></div><div class="txt">'+i.name+'</div><div class="deleteCnt"><div class="deleteIcon"></div></div></div></div><div class="titleGap"></div><div class="dsCnt"></div><div class="cntGap"></div>'),d=$(a[2]),l=$(this.ID+" .dsPanelCnt");e?e.after(a):l.append(a),scrat.utility.handleTruncationTxt(a.find(".txt").prop("originalStr",i.name)),a[0].data_id=i.id,$(a[0]).click(function(){$(this).next().toggle(),$(this).next().next().toggle(),$(this).find(".icon").toggleClass("fold")}),a.find(".deleteCnt").hide().click(function(t){t.stopPropagation();var i=this.parentNode.data_id;s.dsDeleteTrigger(i)}),a.mouseenter(function(){$(this).find(".deleteCnt").show()}),a.mouseleave(function(){$(this).find(".deleteCnt").hide()}),n(i.units.attr),n(i.units.meas),l[0].scrollTop=l[0].scrollHeight},unitTypeChange:function(t,i){t.type!==i&&this.controller.dispatchCubeUnitModifyCmd(t.id,t.cubeID,i)},dsDeleteTrigger:function(t){var i=this;this.controller.dispatchCubeDependentCmd(t,function(e){if(scrat.utility.checkResponseOK(e)){var n,s,a=e.data.sheet_list,d=$("#warningDialog"),l=d.find(".message");l.text("是否确定删除数据集?"),d.find(".advanced, .option").remove(),d.find(".btnCnt").append('<div class="option">继续</div><div class="option">取消</div>');var o=d.find(".option:first"),r=d.find(".option:last");if(a&&a.length>0)for(l.append("<p>以下工作页由于有数据来源于此数据集，因此也将被删除：</p>"),n=0,s=a.length;s>n;n++)l.append("<p>"+a[n].name+"</p>");scrat.initial_data.level>1&&(d.append('<p class="advanced">你是高级用户，因此可以看到下面这个选项：</p>'),d.append('<div class="copy advanced">拷贝</div>'),d.find(".copy").unbind().click(function(){i.controller.ajaxDispatch("POST","data/save",!1,{id:t}),scrat.utility.removePopup()})),o.click(function(){i.controller.dispatchCubeDeleteCmd(t,function(e){i.removePrivate(t),scrat.dsList.removePrivateModel(t);var n=e.data.deleted_sheet_list;n&&n.length&&scrat.sheetSwitchInst.deleteSheetsByIDs(n)}),scrat.utility.removePopup()}),r.click(function(){scrat.utility.removePopup()}),scrat.utility.addPopup(d)}})},removePrivate:function(t){var i,e=$(this.ID+" .dsTitleCnt"),n=e.length;for(i=0;n>i;i++)if(e[i].data_id===t)return $(e[i]).next().remove(),$(e[i]).next().remove(),$(e[i]).next().remove(),void $(e[i]).remove()},removeAllPrivates:function(){$(this.ID+" .dsTitleCnt:gt(0)").remove(),$(this.ID+" .titleGap:gt(0)").remove(),$(this.ID+" .dsCnt:gt(0)").remove()},updatePrivate:function(t){var i,e,n=$(this.ID+" .dsTitleCnt"),s=n.length;for(i=0;s>i;i++)n[i].data_id===t.id&&(e=$(n[i]).prev(),this.removePrivate(t.id),this.addPrivate(t,e))},unitBtndbClick:function(t){this.addUnitFromDataset(t.delegateTarget.data_view.model)},addUnitFromDataset:function(t){t.sel=1,this.controller.dispatchCubeUnitAdd(t)},resetPanelStatus:function(){this.$el.find(".dsCnt").show(),this.$el.find(".dsTitleCnt").find(".icon").removeClass("fold"),this.$el.find(".dsPanelCnt").scrollTop(0),this.$el.find(".dsGroupCnt").hide(),this.$el.find(".dsGroupTitleCnt .icon").removeClass("unfold")},findCntByName:function(t,i){if("upload"===t)return $(this.ID+" .uploadCnt");var e,n,s=$(i?".dsGroupTitleCnt .txt":".dsUnitTxt");for(e=0,n=s.length;n>e;e++)if($(s[e]).text()===t)return $(s[e]).parent();return null}})}();
;!function(){function t(t,e,i,n){var a=i.sheetModel.getSheetUnitModel(e.id),s=a.name;if("省份"===n&&(n="省"),n){var l=s.lastIndexOf("@"+n);-1!==l&&l===s.length-n.length-1&&(s=s.substr(0,l))}var h=new scrat.View({$el:$('<div class="unitCnt"><div class="txt">'+s+'</div><div class="filterIcon"></div></div>')});h.model=a,h.$el[0].data_model=a,h.listenTo("click",function(t){(scrat.utility.isMobile()||"ClickMethodSingle"===scrat.ClickMethod)&&i.attrBtndbClick.call(i,t)}),h.listenTo("dblclick",_.bind(i.attrBtndbClick,i));var r=h.$el.find(".filterIcon");return i.sheetModel.filterModel[a.id]?r.show():r.hide(),r.click(_.bind(i.filterIconClick,i)),h.listenTo("mouseenter",function(){$(this).find(" .filterIcon").show()}),h.listenTo("mouseleave",function(){i.sheetModel.filterModel[a.id]||$(this).find(" .filterIcon").hide()}),t.append(h.$el),scrat.utility.handleTruncationTxt(h.$el.find(".txt")),h}scrat.AnalyzePanel=scrat.classDef(scrat.View,null,{sheetModel:null,init:function(t){this.superCall(t);var e,i=this;$(this.ID+" .switchItemCnt.newObj").click(function(){i.switchToNewMeasEdit.call(i)}),$(this.ID+" .switchItemCnt.used").click(function(){i.switchToUsed.call(i)}),e=$("#analyMeasNameCnt"),e.mouseenter(function(){$(this).find(" .filterIcon").show()}),e.mouseleave(function(t){var e=t.delegateTarget.data_model;i.sheetModel.filterModel[e.id]||$(this).find(" .filterIcon").hide()}),e.find(".filterIcon").click(_.bind(this.filterIconClick,this)),e=$("#newMeasNameCnt"),e.mouseenter(function(t){var e=t.delegateTarget.data_model;e&&$(this).find(" .filterIcon").show()}),e.mouseleave(function(t){var e=t.delegateTarget.data_model;e&&i.sheetModel.filterModel[e.id]||$(this).find(" .filterIcon").hide()}),e.find(".filterIcon").click(_.bind(this.filterIconClick,this)),$("#analyAggSel").change(function(){var t={id:i.currentSelMeasID,agg:$("#analyAggSel").val()};i.controller.dispatchUnitChangeCmd(t,!0)}),$("#analyFormatSel").change(function(){var t=i.sheetModel.getSheetUnitModel(i.currentSelMeasID);if(t){var e=scrat.utility.parseFormatStr(t.fmt);e.type=this.value,i.measFormatChange(i.currentSelMeasID,scrat.utility.packFormatStr(e.type,e.precision))}}),$("#analyPrecSel").change(function(){var t=i.sheetModel.getSheetUnitModel(i.currentSelMeasID);if(t){var e=scrat.utility.parseFormatStr(t.fmt);e.precision=this.value||0,i.measFormatChange(i.currentSelMeasID,scrat.utility.packFormatStr(e.type,e.precision))}}),$("#newMeasFuncInput").focusin(function(){this.data_maximize!==!0&&($(this).animate({width:"300px",height:"60px"},300),this.data_maximize=!0)}),$("#newMeasFuncInput").focusout(function(){this.data_maximize===!0&&($(this).animate({width:"200px",height:"25px"},300),this.data_maximize=!1)}),$("#newMeasSubmit").click(function(){var t={},e=$("#newMeasFuncInput").val();t.expr=e;var n={type:null,precision:null};""!==$("#analyPrecSel").val()&&(n.precision=$("#analyPrecSel").val()),""!==$("#analyFormatSel").val()&&(n.type=$("#analyFormatSel").val());var a=scrat.utility.packFormatStr(n.type,n.precision);a&&(t.fmt=a),""!==i.currentSelMeasID&&(t.id=i.currentSelMeasID),t.name=$("#newMeasNameInput").val()||"新计算",i.controller.dispatchAddDerivedCmd(t),$("#newMeasNameInput").val(""),$("#newMeasFuncInput").val(""),scrat.gridTitleShiftable=!0})},empty:function(){$("#analyMeasEditor").hide(),$("#plainUnitsCnt").hide(),$("#analyAttrCnt").hide(),$(this.ID+" .switchCnt").hide(),$(this.ID+" .switchItemCnt").removeClass("highlight")},doLayout:function(t,e){this.superCall(t,e);var i=t-120;$("#analyAttrCnt").css({width:i}),$("#plainUnitsCnt").css({width:i}),$("#analyAttrCnt .groupCnt").css({width:i}),$("#analyAttrCnt .groupDetailCnt").css({width:i}),this.sheetModel&&this.analyPanelUpdate()},render:function(){return this.empty(),$("#newMeasFuncInput").autocomplete({source:this.sheetModel.getMetricNames().concat(this.sheetModel.getParamNames("?"))}),!this.sheetModel||this.sheetModel.isEmpty()?($(this.ID+" .ruler").hide(),void $("#emptyDataTip").show()):($(this.ID+" .switchCnt").show(),$(this.ID+" .ruler").show(),$("#emptyDataTip").hide(),this.updatePublicHier(this.sheetModel.dimentionsModel),void this.analyPanelUpdate())},layoutPublicAtts:function(t){var e,i,n=100,a=20,s=12,l=$(this.ID+" .groupCnt"),h=l.find(".unitCnt"),r=h.length,o=$(this.ID+" .groupDetailCnt"),d=$("#analyAttrCnt .ruler"),c=$("#analyAttrCnt .arrow"),u=this.sheetModel.highlightUnit;for(i=0;r>i;i++)$(h[i]).css({left:s+(s+n)*i,top:10}),u&&h[i].data_view.model.id===u?$(h[i]).addClass("highlight"):$(h[i]).removeClass("highlight"),t===h[i].data_view.model.id&&(e=i);if(o.find(".unitCnt").hide(),t){t=scrat.utility.getPureID(t);var f=o.find(".unitCnt."+t),g=f.length,m=l.width(),M=Math.floor((m-s)/(n+s));if(g>0){for(f.show(),i=0;g>i;i++)M>i?$(f[i]).css({left:s+(s+n)*i,top:10}):2*M>i?$(f[i]).css({left:s+(s+n)*(i-M),top:a+13}):$(f[i]).hide(),u&&f[i].data_view.model.id===u?$(f[i]).addClass("highlight"):$(f[i]).removeClass("highlight");return d.show(),c.show(),d.css({left:s,width:Math.max(Math.min(M,g),r)*(s+n)-(g>0?s:0)}),void c.css({left:s+(s+n)*e+n/2})}}d.hide(),c.hide()},layoutPlainUnits:function(){var t,e,i=100,n=20,a=12,s=$("#plainUnitsCnt"),l=s.find(".unitCnt"),h=l.length,r=s.width(),o=Math.floor((r-a)/(i+a));for(t=0;h>t;t++)e=Math.floor(t/o),$(l[t]).css({left:a+(a+i)*(t%o),top:a+(a+n)*e})},setModel:function(t){this.sheetModel=t},updatePublicHier:function(t){if(t){var e=this;$(this.ID+" .switchItemCnt:not(.newObj, .used)").remove(),$.each(t.models||[],function(t,i){var n=$('<div class="switchItemCnt"><div class="itemIcon"></div><div class="itemTxt">'+i.name+"</div></div>");$(e.ID+" .switchCnt .newObj").before(n),n.addClass("时间"===i.name?"time":"地理"===i.name?"geo":"secu"),n[0].host=e,n[0].idx=t,n.click(function(t){e.switchToHier.call(e,t.delegateTarget.idx)})}),this.publicHierCnt=t.models.length,$(this.ID+" .switchItemCnt.newObj").show(),$(this.ID+" .switchItemCnt.used").show()}},filterIconClick:function(t){t.stopPropagation();var e=t.delegateTarget.parentNode.data_model;this.controller.unitFilterTrigger(e.id,scrat.utility.getGlobalOffset(t.clientY+14,t.clientX-85))},attrBtndbClick:function(t){var e=t.delegateTarget.data_view.model;this.controller.dispatchSheetUnitAdd(e.id)},measFormatChange:function(t,e){var i=this.sheetModel.getSheetUnitModel(this.currentSelMeasID);if(null!==i){i.fmt=e,scrat.sheetPanelInst.render();var n={id:this.currentSelMeasID,fmt:e};this.controller.dispatchUnitChangeCmd(n)}},analyPanelUpdate:function(){var t=this.sheetModel.highlightUnit;if(void 0===t)return void this.switchToEmpty();if(t===scrat.Enums.SWITCH_USED)return void this.switchToUsed();if(t===scrat.Enums.SWITCH_NEWMEAS)return void this.switchToNewMeasEdit();if(-1===t.indexOf(scrat.Enums.SWITCH_PREFIX)){var e=this.sheetModel.getSheetUnitModel(t);if(e){if(e.getType()===scrat.Enums.UnitType.MEAS)return void this.switchToMeasEdit(t);var i=this.sheetModel.dimentionsModel.getUnitHierarchy(t);if(null===i)return void this.switchToPlainUnits([t]);this.switchToHier(i.index),this.sheetModel.highlightUnit=t;var n=this.sheetModel.dimentionsModel.getUnitGroupID(t);n&&this.layoutPublicAtts(n)}}},switchToHier:function(e){if(!(0>e||e>=this.publicHierCnt)){var i=this.getCurrentHighlight();if(i!==e){this.updateHierHighlight(e),$("#analyMeasEditor").hide(),$("#plainUnitsCnt").hide(),$("#analyAttrCnt").show();var n,a=this,s=$(this.ID+" .groupCnt"),l=$(this.ID+" .groupDetailCnt");s.empty(),l.empty(),this.sheetModel.dimentionsModel.models[e].content.forEach(function(e){n=t(s,e,a),n.listenTo("mouseenter",function(t){var e=t.delegateTarget.data_view.model.id;a.layoutPublicAtts(e)}),e.group instanceof Array&&e.group.forEach(function(i){n=t(l,i,a,e.name),n.$el.addClass(scrat.utility.getPureID(e.id))})}),this.layoutPublicAtts()}}},switchToPlainUnits:function(e){$("#analyMeasEditor").hide(),$("#analyAttrCnt").hide(),$("#plainUnitsCnt").show().empty();var i,n,a=e.length;for(i=0;a>i;i++)n=t($("#plainUnitsCnt"),this.sheetModel.getSheetUnitModel(e[i]),this);this.layoutPlainUnits(),this.updateHierHighlight()},switchToMeasEdit:function(t){this.resetMeasEditorContent();var e=this.sheetModel.getSheetUnitModel(t);if(null!==e){var i=$("#analyMeasNameCnt"),n=i.find(".txt");if($("#analyMeasEditor").show(),$("#analyAttrCnt").hide(),$("#plainUnitsCnt").hide(),n.text(e.name),scrat.utility.handleTruncationTxt(n[0]),i[0].data_model=e,this.sheetModel.filterModel[e.id]?i.find(" .filterIcon").show():i.find(" .filterIcon").hide(),$("#analyMeasEditor .newMeasEditor").hide(),e.type===scrat.Enums.MeasType.DERIVED?($("#analyMeasEditor .measEditor").hide(),$("#analyMeasEditor .derivedMeasEditor").show(),$("#newMeasFuncInput").val(e.expr),$("#newMeasNameInput").val(e.name),$("#newMeasNameCnt")[0].data_model=e):(e.agg&&e.agg.default&&$("#analyAggSel").val(e.agg.default),$("#analyAggTip").text(e.agg&&e.agg.time?"按时间"+scrat.utility.translatAggFunc(e.agg.time):""),$("#analyMeasEditor .derivedMeasEditor").hide(),$("#analyMeasEditor .measEditor").show()),e.fmt){var a=scrat.utility.parseFormatStr(e.fmt);$("#analyFormatSel").val(a.type),$("#analyPrecSel").val(a.precision)}this.currentSelMeasID=e.id;var s=$("#analyMeasNameinfo");scrat.utility.unbindTooltip(s),scrat.utility.bindTooltip(s,"数据集来源： "+scrat.dsList.getNameByID(e.source))}this.updateHierHighlight()},switchToNewMeasEdit:function(){$("#analyMeasEditor").show(),$("#analyAttrCnt").hide(),$("#plainUnitsCnt").hide(),$("#analyMeasEditor .measEditor").hide(),$("#analyMeasEditor .derivedMeasEditor").hide(),$("#analyMeasEditor .newMeasEditor").show(),$("#newMeasNameCnt")[0].data_model=null,this.currentSelMeasID="",this.sheetModel.highlightUnit=scrat.Enums.SWITCH_NEWMEAS,scrat.gridTitleShiftable=!1,this.resetMeasEditorContent(),this.updateHierHighlight(this.publicHierCnt)},switchToUsed:function(){this.sheetModel.highlightUnit=scrat.Enums.SWITCH_USED,this.switchToPlainUnits(scrat.utility.getArrValues(this.sheetModel.used,"id")),this.updateHierHighlight(this.publicHierCnt+1)},switchToEmpty:function(){$("#analyMeasEditor").hide(),$("#plainUnitsCnt").hide(),$("#analyAttrCnt").hide()},resetMeasEditorContent:function(){$("#newMeasFuncInput").val(""),$("#analyPrecSel").val(""),$("#newMeasNameInput").val(""),$("#analyFormatSel").val("")},updateHierHighlight:function(t){if($(this.ID+" .switchItemCnt").removeClass("highlight"),void 0!==t)switch($(this.ID+" .switchItemCnt:eq("+t+")").addClass("highlight"),t){case this.publicHierCnt+1:this.sheetModel.highlightUnit=scrat.Enums.SWITCH_USED;break;case this.publicHierCnt:this.sheetModel.highlightUnit=scrat.Enums.SWITCH_NEWMEAS;break;default:this.sheetModel.highlightUnit=scrat.Enums.SWITCH_PREFIX+t.toString}this.controller.contextPanelChange()},getCurrentHighlight:function(){var t,e=$(this.ID+" .switchItemCnt");for(t=0;t<e.length;t++)if($(e[t]).hasClass("highlight"))return t;return-1},findCntByName:function(t,e){if("used"===t)return $(this.ID+" .switchItemCnt.used");if("derived"===t)return $(this.ID+" .switchItemCnt.newObj");var i,n,a=$(this.ID+" .switchItemCnt");for(i=0,n=a.length;i<Math.min(this.publicHierCnt,n);i++)if($(a[i]).find(".itemTxt").text()===t)return $(a[i]);var s=$(this.ID+" .unitCnt .txt");for(i=0,n=s.length;n>i;i++)if($(s[i]).text()===t)return"filter"===e?$(s[i]).next():$(s[i]).parent();return null}})}();
;!function(){scrat.FilterEditor=scrat.classDef(scrat.View,null,{sheetModel:null,currentUnit:null,attFlySelElements:[],isPageBy:!1,isStock:!1,isChart:!1,stockCallbck:null,init:function(t){this.superCall(t);var e,i=this;$("#attFilterList").click(_.bind(this.attFilterClick,this)),$("#attrFilterEditor .search").keyup(function(t){$("#attFilterList .itemCnt:first").find(".showBtn").text("显示已选择"),clearTimeout(e),e=setTimeout(function(){i.controller.dispatchUnitDefFetchCmd(i.currentUnit.id,_.bind(i.attFilterSearch,i),$(t.delegateTarget).val())},200)}),$("#attrFilterSubmit").click(_.bind(this.submitAttFilterBtn,this)),$("#attrTimeFilterSubmit").click(_.bind(this.submitAttTimeFilterBtn,this)),this.measFilterCnts=[$("#measFilterValCnt").click(_.bind(this.measFilterClick,this)),$("#measFilterTopRank").click(_.bind(this.measFilterClick,this)),$("#measFilterBottomRank").click(_.bind(this.measFilterClick,this)),$("#measFilterNotNullTitle").click(_.bind(this.measFilterClick,this)),$("#measFilterNullTitle").click(_.bind(this.measFilterClick,this))];$("#measFilterEditor .filterOKBtn").click(_.bind(this.submitMeasFilterBtn,this)),$("#attrFilterCancel").click(function(){$("#attrFilterEditor").hide()}),$("#attrTimeFilterCancel").click(function(){$("#attrTimeFilterEditor").hide()}),$("#measFilterCancel").click(function(){$("#measFilterEditor").hide()})},invokeNormalAttFilter:function(t,e){void 0===t.filter_style?this.controller.dispatchUnitDefFetchCmd(t.id,_.bind(function(i){if(t.filter_style=i.data.ele_content.style,"list"===t.filter_style){var l=i.data.ele_content.ele_list;t.ele_list=l.data,t.d=l.d,this.invokeListAttFilter(t,e)}else"range"===t.filter_style&&(t.filterHint=i.data.ele_content.hint||["",""],this.invokeTimeAttFilter(t,e))},this)):"list"===t.filter_style?this.invokeListAttFilter(t,e):this.invokeTimeAttFilter(t,e)},invokeListAttFilter:function(t,e){var i,l,a,s=$("#attFilterList"),r=t.d.id,n=t.d.disp,d=[],c=this;this.attFlySelElements=[],this.currentUnit=t,s.empty(),$("#attrFilterEditor .search").show().val("");var o=this.sheetModel.filterModel[t.id];if(o&&o.val&&o.val instanceof Array&&(d=o.val),1e3===t.ele_list[r].length)for(l=0,a=d.length;a>l;l++)-1===t.ele_list[r].indexOf(d[l])&&(t.ele_list[r].push(d[l]),t.ele_list[n].push(o.desc[l]));i=0===d.length;var h=$('<div class="itemCnt"><div class="indicator '+(i?"checked":"")+'"></div><label>全选</label><div  class="showBtn">显示已选择</div></div>');h.find(".showBtn").click(function(e){var i=$("#attFilterList .indicator:first").hasClass("checked");c.attFlySelElements=c.getAttSelElements(),"显示已选择"===$(this).text()?(c.updateAttFilterList(t.ele_list,r,n,c.attFlySelElements,i,!0),$(this).text("显示全部")):"显示全部"===$(this).text()&&(c.attFlySelElements=c.getAttSelElements(),c.updateAttFilterList(t.ele_list,r,n,c.attFlySelElements,i,!1),$(this).text("显示已选择")),e.stopPropagation()}),i&&h.find(".showBtn").hide(),h[0].data_id=scrat.Enums.ALL+"-attFilterList",s.append(h),$("#attFilterList").innerWidth("auto"),this.updateAttFilterList(t.ele_list,r,n,d,i),scrat.utility.addPopup($("#attrFilterEditor").css(e));var F=$("#attFilterList").innerWidth();$("#attFilterList").innerWidth(F+20),this.isPageBy||$("#attrFilterEditor .search").focus()},invokePageBySel:function(t,e,i,l){var a=$("#attFilterList");this.currentUnit=this.sheetModel.getSheetUnitModel(t),this.isPageBy=!0,a.empty(),$("#attrFilterEditor .search").hide(),$("#attFilterList").innerWidth("auto"),this.updateAttFilterList(e,0,1,i,!1),scrat.utility.addPopup($("#attrFilterEditor").css(l));var s=$("#attFilterList").innerWidth();$("#attFilterList").innerWidth(s+20)},invokeStockSel:function(t,e,i){var l=$("#attFilterList"),a=!this.isChart&&0===t.selected.length||t.ele_list.id.length===t.selected.length;this.isStock=!0,this.currentUnit={id:t.id,model:t},this.stockCallbck=i,t.isChart&&(this.isChart=!0),l.empty();var s=$('<div class="itemCnt"><div class="indicator '+(a?"checked":"")+'"></div><label>全选</label></div>');s[0].data_id=scrat.Enums.ALL+"-attFilterList",l.append(s),$("#attrFilterEditor .search").hide(),$("#attrFilterEditor .filterOKBtn").hide(),$("#attFilterList").innerWidth("auto"),this.updateAttFilterList(t.ele_list,"id","desc",t.selected,a),scrat.utility.addPopup($("#attrFilterEditor").css(e));var r=$("#attFilterList").innerWidth();$("#attFilterList").innerWidth(r+20)},updateAttFilterList:function(t,e,i,l,a,s){var r,n=$("#attFilterList"),d=$("#attFilterList .itemCnt:gt(0)").hide(),c=d.length,o=function(t){for(var e=0;c>e;e++)if(d[e].data_id===t)return d[e];return null};n.find(".clear").remove(),$.each(t[e],function(e,d){(!s||a||-1!==l.indexOf(d))&&(n.append('<div class="clear"></div>'),r=o(d),r=$(r?r:'<div class="itemCnt"><div class="indicator"></div><label></label></div>'),a||-1!==l.indexOf(d)?r.find(".indicator").addClass("checked"):r.find(".indicator").removeClass("checked"),r.find("label").text(t[i][e]),r[0].data_id=d,n.append(r.show()))})},invokeTimeAttFilter:function(t,e){this.currentUnit=t;var i=this.sheetModel.filterModel[t.id],l=$("#attrTimeFilterSta"),a=$("#attrTimeFilterEnd");l.attr("placeholder",t.filterHint[0]).val(""),a.attr("placeholder",t.filterHint[1]).val(""),i&&(i.op===scrat.Enums.MeasFilterType.VALUE_BETWEEN&&i.val?(l.val(i.val[0]),a.val(i.val[1])):i.op===scrat.Enums.MeasFilterType.GE?l.val(i.val):i.op===scrat.Enums.MeasFilterType.LE&&a.val(i.val)),scrat.utility.addPopup($("#attrTimeFilterEditor").css(e))},invokeMeasFilter:function(t,e){this.currentUnit=t;var i=["",""];$("#measFilterValSta").attr("placeholder",(t.rng||i)[0]),$("#measFilterValEnd").attr("placeholder",(t.rng||i)[1]),$("#measFilterValSta").val(""),$("#measFilterValEnd").val(""),$("#measFilterRankTop").val(""),$("#measFilterRankBottom").val("");var l,a=this.sheetModel.filterModel[t.id],s=a&&a.op||"",r=scrat.Enums.MeasFilterType,n={};n[r.VALUE_BETWEEN]="measFilterValCnt",n[r.TOP]="measFilterTopRank",n[r.BOTTOM]="measFilterBottomRank",n[r.NOTNULL]="measFilterNotNullTitle",n[r.NULL]="measFilterNullTitle",l=n[s],$.each(this.measFilterCnts,function(t,e){e.removeClass("grey"),e.attr("id")===l?(e.addClass("measFilterTitleSel"),s===r.VALUE_BETWEEN?($("#measFilterValSta").val(a.val[0]),$("#measFilterValEnd").val(a.val[1])):s===r.TOP?$("#measFilterRankTop").val(a.val):s===r.BOTTOM&&$("#measFilterRankBottom").val(a.val)):e.removeClass("measFilterTitleSel")}),scrat.utility.addPopup($("#measFilterEditor").css(e))},invokeFilter:function(t,e){scrat.gridTitleShiftable=!1,this.isPageBy=!1;var i=this.sheetModel.getSheetUnitModel(t);return"meas"===i.getType()?void this.invokeMeasFilter(i,e):void this.invokeNormalAttFilter(i,e)},attFilterSearch:function(t){if(scrat.utility.checkResponseData(t)){var e=t.data.ele_content.ele_list,i=$("#attFilterList .indicator:first").hasClass("checked");this.attFlySelElements=this.getAttSelElements(),this.updateAttFilterList(e.data,e.d.id,e.d.disp,this.attFlySelElements,i)}},attFilterClick:function(t){for(var e,i=t.target;-1===i.className.indexOf("itemCnt")&&i!==t.delegateTarget;)i=i.parentNode;if(-1!==i.className.indexOf("itemCnt")){if(e=$("#attFilterList .indicator:first"),0===i.data_id.toString().indexOf(scrat.Enums.ALL+"-"))e.toggleClass("checked"),e.hasClass("checked")?$("#attFilterList .indicator").addClass("checked"):$("#attFilterList .indicator").removeClass("checked");else{var l=$(i).find(".indicator");l.toggleClass("checked"),l.hasClass("checked")||this.isPageBy||e.removeClass("checked")}e.hasClass("checked")||$("#attFilterList .itemCnt:first").find(".showBtn").show(),this.isStock&&this.handleAttFilter(this.currentUnit.id)}},measFilterClick:function(t){var e=scrat.Enums.MeasFilterType,i=this;$.each(i.measFilterCnts,function(l,a){if(a.attr("id")===t.delegateTarget.id){a.addClass("measFilterTitleSel"),a.removeClass("grey");var s={measFilterValCnt:e.VALUE_BETWEEN,measFilterTopRank:e.TOP,measFilterBottomRank:e.BOTTOM,measFilterNotNullTitle:e.NOTNULL,measFilterNullTitle:e.NULL};i.currentMeasFilterTyp=s[a.attr("id")]}else a.removeClass("measFilterTitleSel"),a.addClass("grey")})},submitAttTimeFilterBtn:function(){this.handleAttTimeFilter(this.currentUnit.id),scrat.utility.removePopup()},handleAttTimeFilter:function(t){var e=$("#attrTimeFilterSta").val(),i=$("#attrTimeFilterEnd").val();(""!==e||""!==i)&&(this.sheetModel.filterModel[t]={op:scrat.Enums.MeasFilterType.VALUE_BETWEEN,val:[e,i]},this.controller.dispatchFilter(t))},submitAttFilterBtn:function(){this.handleAttFilter(this.currentUnit.id),scrat.utility.removePopup()},handleAttFilter:function(t){var e=this.getAttSelElements();this.isPageBy?this.controller.dispatchPageByCmd(t,e):this.isStock?(this.currentUnit.model.selected=this.isChart?e:$("#attFilterList .indicator:eq(0)").hasClass("checked")?[]:e,this.stockCallbck()):(this.sheetModel.filterModel[t]={op:scrat.Enums.MeasFilterType.IN,val:[]},$("#attFilterList .indicator:first").hasClass("checked")&&this.sheetModel.filterModel.hasOwnProperty(t)?delete this.sheetModel.filterModel[t]:this.sheetModel.filterModel[t].val=e,this.controller.dispatchFilter(t))},getAttSelElements:function(){var t=[],e=$(this.isPageBy?"#attFilterList .indicator":"#attFilterList .indicator:gt(0)");return $.each(e,function(e,i){$(i).hasClass("checked")&&t.push(i.parentNode.data_id)}),t},submitMeasFilterBtn:function(){this.handleMeasFilter(this.currentUnit.id),scrat.utility.removePopup()},handleMeasFilter:function(t){var e={};switch(this.currentMeasFilterTyp){case scrat.Enums.MeasFilterType.EMPTY:return;case scrat.Enums.MeasFilterType.VALUE_BETWEEN:e={val:[$("#measFilterValSta").val()||$("#measFilterValSta").attr("placeholder"),$("#measFilterValEnd").val()||$("#measFilterValEnd").attr("placeholder")]};break;case scrat.Enums.MeasFilterType.TOP:e={val:$("#measFilterRankTop").val()};break;case scrat.Enums.MeasFilterType.BOTTOM:e={val:$("#measFilterRankBottom").val()};break;case scrat.Enums.MeasFilterType.NOTNULL:case scrat.Enums.MeasFilterType.NULL:break;default:return}e.op=this.currentMeasFilterTyp,this.sheetModel.filterModel[t]=e,this.controller.dispatchFilter(t)},findCntByName:function(t){return $("attr"===t?"#attrFilterEditor":"#measFilterEditor")},attFilterAllSelected:function(){return $("#attFilterList .indicator:first").hasClass("checked")}})}();
;!function(){scrat.GridViewer=scrat.classDef(scrat.View,null,{sheetModel:null,viewerPanel:null,cellSelCallback:null,disableDeleteBtn:!1,fitWindow:!1,cellSelIndex:-1,stockIDIndex:-1,isAsset:!1,isRealtime:!1,hasHoldingStatus:!1,stockNameIndex:-1,stockTypeIndex:-1,pivottable:!0,sortable:!0,resizable:!0,hasIndexCol:!1,pickedNames:null,headerInfo:{},doLayout:function(t,e){this.superCall(t,e),this.sheetModel&&!this.sheetModel.isEmpty()&&this.render()},render:function(){if(this.sheetModel){this.empty();var t,e=[],i=this.sheetModel.sheetData,a=this.sheetModel.clientProp,n=this.sheetModel.sheetLayout.format&&this.sheetModel.sheetLayout.format.colSize||{},s=0,o=this,r=scrat.utility.fromWechat()?1:22,l=150,d=140,h=!1,c=76;if($.each(i.row,function(t,e){e=o.sheetModel.getSheetUnitModel(e.id),"股票代码"===e.name&&(h=!0)}),o.hasIndexCol&&e.push({typ:scrat.Enums.UnitType.ATTR,title:"序号",align:"center",width:l,id:"indexCol",sort:!1}),$.each(i.row,function(t,i){if(i=o.sheetModel.getSheetUnitModel(i.id),o.pickedNames&&-1===o.pickedNames.indexOf(i.name))return void s++;var a={};a.typ=scrat.Enums.UnitType.ATTR,a.field=(s++).toString(),a.disFormIdx=i.d.disp,a.idFormIdx=i.d.id,a.sortFormIdx=i.d.sort,a.title=i.name,a.id=i.id,a.width=n[a.id]||l,a.sort=o.sortable,a.align="center",a.sizeable=o.resizable,a.comparator=function(t,e,i,a){return t[a]==e[a]?0:i?t[a]<e[a]?1:-1:t[a]>e[a]?1:-1},"股票代码"===a.title||"基金代码"===a.title?o.stockIDIndex=a.field:"策略代码"===a.title&&(o.stockIDIndex=a.field,o.isAsset=!0),(-1!==a.title.indexOf("股票名")||-1!==a.title.indexOf("基金名")||-1!==a.title.indexOf("策略名"))&&(o.stockNameIndex=a.field),-1!==a.title.indexOf("策略类型")&&(o.stockTypeIndex=a.field),e.push(a)}),t=s,$.each(i.col,function(t,i){if(i=o.sheetModel.getSheetUnitModel(i.id),o.pickedNames&&-1===o.pickedNames.indexOf(i.name))return void s++;var a={};a.typ=scrat.Enums.UnitType.MEAS,a.field=(s++).toString(),a.title=i.name+scrat.utility.getFormatPostFix(i.fmt),a.id=i.id,a.width=n[a.id]||l,a.sort=o.sortable,a.align="center",a.sizeable=o.resizable,a.formatter=function(t,e){return scrat.utility.formatNumbe(t,e)},a.fmt=i.fmt,"holding_status"===a.id&&(o.hasHoldingStatus=!0),e.push(a)}),this.fitWindow){var u=e.length;o.isAsset&&(u-=1),o.hasHoldingStatus&&(u-=1),l=parseInt((this.$el.actual("width")-r-u)/u),!scrat.utility.fromWechat()&&h&&d>l&&(l=parseInt((this.$el.actual("width")-r-u+1-d)/(u-1)))}scrat.appType===scrat.Enums.APPType.STOCK&&(l=c>l?c:l),$.each(e,function(t,e){e.width=n[e.id]||l,("股票代码"===e.title||"基金代码"===e.title)&&(scrat.utility.fromWechat()||(e.width=Math.max(e.width,140)))}),this.gridInst=this.createGrid(this.$el,{cols:e,attCnt:t,dp:i.reOrgData,total:this.sheetModel.sheetData.rowTotalCnt,rowScroll:a.rowScroll,colScroll:a.colScroll})}},empty:function(){this.$el.empty()},updateHighlight:function(){this.gridInst&&this.gridInst.resetHighlight(this.sheetModel.highlightUnit)},createGrid:function(t,e){t.getTotalWidth=function(t){var i,a,n=0;for(a=e.cols.length,t.isAsset&&(a-=1),t.hasHoldingStatus&&(a-=1),i=0;a>i;i++)n+=e.cols[i].width,n+=e.bordeThick;return n+=e.bordeThick},e.headerClickHighlight=scrat.appType===scrat.Enums.APPType.PLATFORM,e.rowHeight=e.rowHeight||24,e.headerHeight=30,e.partialRenderSize=100,e.bordeThick=1,t.config=e,t.dp=e.dp,t.data={},t.curRowCnt=t.dp.length,t.colCnt=e.cols.length,t.contentW=t.getTotalWidth(this),t.contentH=t.curRowCnt*(e.rowHeight+1)+e.bordeThick+e.headerHeight,t.windowW=t.actual("width"),t.windowH=t.height(),t.showYbar=t.contentH>t.windowH,t.horScrllH=t.contentW>t.windowW?scrat.globalConst.scrollBarSize:0,t.YbarW=t.showYbar?scrat.globalConst.scrollBarSize:0,e.partialRenderSize=Math.ceil(t.windowH/(e.rowHeight+e.bordeThick)),t.chunkPending=!1;var i,a=this.controller,n=this,s=$('<div class="main"></div>').appendTo(t),o=$('<div class="headCnt"></div>').appendTo(s),r=$('<div class="head"></div>').appendTo(o);s.append('<div class="clear"></div>');var l=$('<div class="body"></div>').appendTo(s),d=$('<div class="tt"></div>').appendTo(l);t.adjustYBar=function(){},0===t.horScrllH&&(e.colScroll=n.sheetModel.clientProp.colScroll=0),s.width(Math.min(t.windowW,t.contentW+t.YbarW)),s.height(Math.min(t.windowH,t.contentH+t.horScrllH)),o.width(s.width()-t.YbarW),o.height(e.headerHeight+e.bordeThick),r.width(t.contentW-e.bordeThick),r.height(e.headerHeight),l.css("top",e.headerHeight+e.bordeThick),l.width(s.width()),l.height(Math.min(t.windowH,t.contentH+t.horScrllH)-e.headerHeight),d.width(t.contentW-e.bordeThick),d.height(t.contentH-e.headerHeight),t.adjustYBar(),t.scrlSize=d.height();var h,c,u,f,p=$('<div class="icon-pivot" unselectable="on"></div>').appendTo(r);r.mouseleave(function(){p.hide()}),$("body").mousemove(function(i){if(c){var a,u,f=i.clientX-c.mouseX,p=c.th,g=p.width()+f,m=d.width()+f,v=l.width()+f,w={};if(g>0){for(t.contentW+=f,s.width(Math.min(t.windowW,t.contentW+t.YbarW)),o.width(Math.min(t.contentW,t.windowW-t.YbarW)),l.width(s.width()),d.width(m),d.find(".tr").width(v),r.width(r.width()+f),c.mouseX=i.clientX,s.find('[name="'+c.name+'"]').width(g),a=0,u=e.cols.length;u>a;a++)e.cols[a].name===c.name&&(e.cols[a].width=g);if(t.adjustYBar(),n.controller){for(a=0,u=e.cols.length;u>a;a++)w[e.cols[a].id]=e.cols[a].width;n.sheetModel.sheetLayout.format.colSize=w,n.controller.dispatchFormatCgeCmd({colSize:w})}}}if(h){var f=i.clientX-h.mouseX,C=i.clientY-h.mouseY;h.css({left:h.origX+f,top:h.origY+C+30})}}).mouseup(function(){c&&($.each(e.cols,function(t,e){e.name===c.name&&(e.width=r.find("[name="+e.name+"]").width()),c.group&&e.name==c.group&&(e.width=r.find("[name="+c.group+"]").width())}),c=null),h&&(scrat.gridTitleShiftable=!0,p.hide(),h.remove(),h=null)}),t.sortBy=[];var g=0;return $.each(e.cols,function(o,l){if((l.field!==n.stockTypeIndex||scrat.appType!==scrat.Enums.APPType.STOCK||!n.isAsset)&&"holding_status"!==l.id){var d=l.name=l.name||l.field,m=$("<div></div>").attr("name",d).attr("unitid",l.id),v=l.parent||r;if(m.appendTo(v),l.parent&&(m.attr("group",l.group),m.parents(".th").css("border-right","none")),l.hidden)return void m.hide();if(l.isGroup||(g+=l.width+(l.parent?1:2)),n.pivottable&&m.attr("unselectable","on"),l.sizeable!==!1&&!l.isGroup){var w=$('<div class="sizer" unselectable="on"></div>');w.mousedown(function(t){var i=e.fixedCols||[];if($.inArray(l.field,i)<0&&$.inArray(l.group,i)<0){var a=r.find("[name="+d+"]"),n=a.attr("name");c={th:a,name:n,group:a.attr("group"),mouseX:t.clientX}}return!1}).appendTo(m)}m.width(l.width),n.disableDeleteBtn||(T=$('<span class="icon delete"></span>'),T.prop("unitid",l.id),$('<div class="deleteCnt"></div>').append(T).appendTo(m),T.parent().click(function(t){var i=$(this).find(".icon")[0].unitid;if(a.dispatchUnitDelete(i),void 0===n.sheetModel.highlightUnit||i===n.sheetModel.highlightUnit){var s=$.map(e.cols,function(t){return t.id}).indexOf(i),o=e.cols[s>0?s-1:e.cols.length-1].id;n.sheetModel.highlightUnit=e.cols.length>1?o:scrat.Enums.SWITCH_USED}t.stopPropagation()}));var C=n.sheetModel.getSheetUnitModel(l.id),S=C&&(C.sort||scrat.Enums.SortStatus.DEFAULT);if(t.sortBy.push({field:d,sort:S,id:l.id}),l.sort!==!1){var T=$('<span class="icon"></span>');$('<div class="sort"></div>').append(T).appendTo(m);var b=S===scrat.Enums.SortStatus.DEFAULT?"sortNormal":S===scrat.Enums.SortStatus.ASC?"sortAsc":"sortDes";T.addClass(b),S===scrat.Enums.SortStatus.DEFAULT&&T.hide()}if(n.headerInfo[l.title]){var k=$('<span class="glyphicon glyphicon-info-sign info"></span>');m.append(k),scrat.utility.bindTooltip(k,n.headerInfo[l.title])}var y=l.header;if(!y){y=$('<div class="title"></div>').append("<span>"+l.title+"</span>"),scrat.measList&&scrat.measList[l.id]&&1===scrat.measList[l.id].realtime&&n.isRealtime&&y.addClass("red"),n.pivottable&&y.attr("unselectable","on");var x=l.parent?l.height||e.rowHeight:e.headerHeight||e.rowHeight;y.height(x).css("line-height",x+"px")}var H;0!=l.moveable&&y.mousedown(function(t){H=!0,scrat.gridTitleShiftable=!1;var a=e.fixedCols||[];return $.inArray(l.field,a)<0&&$.inArray(l.group,a)<0&&n.pivottable&&(i=setTimeout(function(){h=$('<div class="dragHelper" id="'+l.id+'"><div>'),h.html("&nbsp;"+l.title+"&nbsp;"),h.field=$(t.delegateTarget).parent().attr("name"),h[0].unitid=l.id,h.width(l.width),$("body").append(h);var e=$(t.target).offset();h.css({left:e.left,top:e.top+30}),h.mouseX=t.clientX,h.mouseY=t.clientY,h.origX=e.left,h.origY=e.top,h.dragging=!0,h.mousemove(function(t){var e=t.clientX-h.mouseX,i=t.clientY-h.mouseY;h.css({left:h.origX+e,top:h.origY+i})})},100)),n.pivottable?!1:!0}).mousemove(function(i){if(h){var a=h.field<e.attCnt,n=d<e.attCnt;if(a&&n||!a&&!n){var s=$(i.delegateTarget).position().left,o=$(i.delegateTarget).parent().outerWidth(),r=i.offsetX<o/2,l=r?s-2:s+o-2;l=Math.max(l,0),l=Math.min(l,t.contentW-3),p.show().css("left",l)}else p.hide()}}).mouseout(function(){H=!1,clearTimeout(i)}).mouseup(function(o){clearTimeout(i),H&&(e.headerClickHighlight&&(n.sheetModel.highlightUnit=l.id,a.unitContextChange(),t.resetHighlight(l.id)),H=!1,scrat.gridTitleShiftable=!0);var r=e.fixedCols||[],d=$(o.delegateTarget).parent().attr("name");if($.inArray(d,r)>=0)return!0;if(h&&d!=h.field&&"none"!==p.css("display")){var c,u=s.find(".td[name="+d+"],.th[name="+d+"]"),f=$(o.delegateTarget).parent().outerWidth(),g=o.offsetX<f/2,m=[],v=[];$.each(u,function(t,e){var i=$(e),a=i.parent(),n=a.find(".td[name="+h.field+"],.th[name="+h.field+"]");g?i.before(n):i.after(n)});var w=$.inArray(d,$.map(e.cols,function(t){return t.name||t.field})),C=$.inArray(h.field,$.map(e.cols,function(t){return t.field}));for(n.sheetModel.highlightUnit=e.cols[C].id,e.cols.splice(g?w:w+1,0,e.cols[C]),e.cols.splice(C>w?C+1:C,1),a.unitContextChange(),c=0;c<e.attCnt;c++)m.push(e.cols[c].id);for(c=e.attCnt;c<e.cols.length;c++)v.push(e.cols[c].id);a.dispatchPivotCmd(m,v),t.resetHighlight(h[0].unitid),h.remove(),h=null}p.hide()}),m.mouseenter(function(t){h||c||($(this).find(".icon").show(),u=$(this).find(".delete"),f=$(this).find(".sort .icon"),$(t.delegateTarget).hasClass("highlight")?(u.addClass("highlight"),f.addClass("highlight")):(u.removeClass("highlight"),f.removeClass("highlight")))}).mouseleave(function(){$(this).find(".delete").hide(),$(this).find(".sortNormal").hide()}),m.addClass("th").append(y),l.id===n.sheetModel.highlightUnit&&e.headerClickHighlight&&m.addClass("highlight")}}),t.resetHighlight=function(i){e.headerClickHighlight&&(i?(r.find('.th[unitid!="'+i+'"]').removeClass("highlight"),r.find('.th[unitid!="'+i+'"] .icon').removeClass("highlight"),r.find('.th[unitid="'+i+'"]').addClass("highlight"),r.find('.th[unitid="'+i+'"] .icon').addClass("highlight")):t.clearHighlight())},t.clearHighlight=function(){r.find(".th").removeClass("highlight"),r.find(".icon").removeClass("highlight")},t.sort=function(){var i,s,o,r,d=t.sortBy,h=[],c=!1;$.each(d,function(t,e){e.sort!==scrat.Enums.SortStatus.DEFAULT&&(c=!0)}),c?($.each(t.dp,function(t,e){h.push(e)}),h.sort(function(t,a){for(i=0;i<d.length;i++)if(d[i].sort&&d[i].sort!==scrat.Enums.SortStatus.DEFAULT&&(s=d[i].field,o=t[s],r=a[s],void 0!==o&&void 0!==r)){var l=e.cols[parseInt(s)+(n.hasIndexCol?1:0)],h=l.comparator;if(h){var c=h(o,r,d[i].sort===scrat.Enums.SortStatus.DEC,l.sortFormIdx||0);if(0===c)continue;return c}if(o!=r)return d[i].sort===scrat.Enums.SortStatus.ASC?o>r?1:-1:r>o?1:-1}return 0}),t.initData(h)):t.initData(t.dp),"sortclient"===scrat.sortMethod?l.scroll():a.dispatchSorting(d)},r.find(".sort").click(function(){for(var e=$(this).hide(),i="sortAsc",a="sortDes",n="sortNormal",s=e.parent().attr("name"),o=e.children(),r=t.sortBy,l="",d=0;d<r.length;d++)if(r[d].field==s){l=r[d].id,r.splice(d,1);break}return o.hasClass(n)?(r=r.unshift({field:s,sort:scrat.Enums.SortStatus.ASC,id:l}),o.removeClass(n).addClass(i)):o.hasClass(i)?(r=r.unshift({field:s,sort:scrat.Enums.SortStatus.DEC,id:l}),o.removeClass(i).addClass(a)):o.hasClass(a)&&(r=r.unshift({field:s,sort:scrat.Enums.SortStatus.DEFAULT,id:l}),o.removeClass(a).addClass(n)),o.show(),t.sort(),!1}),t.newRow=function(i,a){var s=e.key?i[e.key]:"r"+a;if(t.data[s].show!==!0){t.data[s].show=!0;var o=$('<div name="'+s+'" class="tr"></div>');o.height(e.rowHeight),o.width(t.contentW),o.css("top",(e.rowHeight+1)*a),$.each(e.cols,function(t,e){var s=$('<div class="td"></div>');if(e.field!==n.stockTypeIndex||scrat.appType!==scrat.Enums.APPType.STOCK||!n.isAsset){if("holding_status"===e.id)return void(i[e.field]&&o.addClass("holding-bgColor"));if(s.attr("name",e.name||e.field),s.width(e.width),e.field===n.cellSelIndex&&(s.addClass("link").click(function(){n.cellSelCallback&&n.cellSelCallback(i[0][0],i[1][1],i[2][1])}),scrat.utility.bindTooltip(s,"点击查看详情")),e.group){var r=o.find(".td[name="+e.group+"]");r.css("border-right","none"),r.append(s),s.attr("group",e.group)}else s.appendTo(o);var l,d=parseInt(e.field);if("indexCol"===e.id?l=a+1:e.formatter?(l=e.formatter(i[d],e.fmt),-1!==e.fmt.indexOf("#c")&&i[d]<0&&s.addClass("neg")):l=e.typ===scrat.Enums.UnitType.ATTR?i[d][e.disFormIdx]:i[d],e.title&&-1!==e.title.indexOf("日涨幅")&&-1!==l.indexOf("%")&&(parseFloat(l)>0?s.addClass("red"):parseFloat(l)<0&&s.addClass("green")),e.field===n.stockIDIndex&&scrat.appType===scrat.Enums.APPType.STOCK){var h,c,u=$('<span class="link">'+l+"</span>"),f=i[n.stockIDIndex][1],p=["60","50","51"],g=["15","16","50","51"],m=-1!==p.indexOf(f.substr(0,2));u.click(function(){n.stockPageOpenCallback(i[n.stockIDIndex][0],i[n.stockIDIndex][1],i[n.stockNameIndex][1])}),s.append(u),scrat.utility.fromWechat()||n.isAsset||(h=-1!==g.indexOf(f.substr(0,2)),c=h?"http://finance.sina.com.cn/fund/quotes/"+f+"/bc.shtml":"http://finance.sina.com.cn/realstock/company/"+(m?"sh":"sz")+f+"/nc.shtml",s.append($('<a href="http://xueqiu.com/S/'+(m?"SH":"SZ")+f+'" target="_blank"><img src="/static/images/logo_xueqiu.png"></a><a href="'+c+'" target="_blank"><img src="/static/images/logo_sina.png"></a>')),s.mouseenter(function(){s.find("span").css("padding-left",44),s.find("img").show()}).mouseleave(function(){s.find("span").css("padding-left",0),s.find("img").hide()}))}else s[0].originalStr=l,s.append(l),s.append("&nbsp;"),e.sizeable||scrat.utility.handleTruncationTxt(s);e.hidden&&s.hide()}}),o.click(function(){t.find(".tr").removeClass("selected"),t.selected=$(this).addClass("selected")}).append('<div class="clear"></div>'),d.append('<div class="clear"></div>'),d.append(o)}},t.addRow=function(e,i){t.newRow(e,i)},t.delRow=function(e){if(e=e||[],0==e.length){var i=t.selected;i&&e.push(i.attr("name")),t.selected=null}return $.each(e,function(e,i){t.data[i]&&delete t.data[i];var a=d.children(".tr[name="+i+"]");a.next().remove(),a.remove()}),t.adjustYBar(),e},t.fillinData=function(e,i){var a,n,s=e>=0?e:0,o=i<t.curRowCnt?i:t.curRowCnt;for(a=s;o>a;a++)n="r"+a,t.addRow(t.data[n],a);d.find(".tr:odd").addClass("h2o"),d.find(".tr:even").addClass("h2e"),r.find(".sort").show(),r.find(".sort").show()},t.initData=function(i){d.empty(),t.data={},$.each(i,function(i,a){var n=e.key?a[e.key]:"r"+i;t.data[n]=a,t.data[n].show=!1})},l.mousewheel(function(){}),l.scroll(function(){n.sheetModel.clientProp.colScroll=this.scrollLeft,o.scrollLeft(this.scrollLeft);var i=parseInt(this.scrollTop/(e.rowHeight+1));if(t.fillinData(i,i+e.partialRenderSize),n.sheetModel.clientProp.rowScroll=this.scrollTop,this.scrollTop>t.scrlSize-t.windowH&&t.curRowCnt<e.total&&!t.chunkPending){var s=t.curRowCnt+scrat.globalConst.chunkSize;t.chunkPending=!0,a.dispatchChunkRequest(t.curRowCnt,s,_.bind(n.chunkCallbck,n))}}),scrat.viewInst&&scrat.viewInst.currentSort&&"sortclient"===scrat.sortMethod?t.sort():(t.initData(t.dp),t.fillinData(0,e.partialRenderSize)),l.scrollLeft(e.colScroll||0),t.fillChunkData=function(i){var a=i.length,n=a*(e.rowHeight+e.bordeThick);$.each(i,function(i,a){var n=e.key?a[e.key]:"r"+(t.curRowCnt+i);t.data[n]=a,t.data[n].show=!1}),t.curRowCnt+=a,t.contentH+=n,d.height(d.height()+n),t.scrlSize+=n,t.chunkPending=!1},t},chunkCallbck:function(t){t.data&&t.data.sheet_data&&this.fillChunkData(t.data.sheet_data)},fillChunkData:function(t){var e=this.sheetModel.sheetData.fillinChunkData(t);this.gridInst.fillChunkData(e),this.viewerPanel.updateSummaryInfo()},findCntByName:function(t,e){var i,a,n=this.$el.find(".head .th .title span"),s=null;for(i=0,a=n.length;a>i;i++)$(n[i]).text()===t&&(s="delete"===e?$(n[i]).parent().prev().prev():"sort"===e?$(n[i]).parent().prev():$(n[i]).parent());return s}})}();
;!function(){function t(t,e,a,i){t.empty().unbind(),i&&t.append($('<option value="all" name="radio">全部时间</option>'));var s,n=e.length;for(s=0;n>s;s++)t.append($('<option value="'+s+'" name="radio">'+e[s]+"</option>"));t.change(function(t){a(this.value,t)})}function e(t,e){var a,i,s,n;for(a=0,i=t.length;i>a;a++)for(s=0,n=e.length;n>s;s++)delete t[a].properties[e[s]]}function a(t){$("#animateSel").hide(),$("#animateSlider ~ span").hide(),$("#animateSlider").show(),$("#mainView .animateLabel").text(t)}function i(){$("#animateSel").show(),$("#animateCnt span").show(),$("#animateSlider").hide(),$("#mainView .animateLabel").text("")}function s(t){var e=scrat.utility.formatNumbe(t.rng[0],t.fmt),a=scrat.utility.formatNumbe(t.rng[1],t.fmt),i=scrat.utility.measureTextWidth(e,{fontFamily:"Arial"}),s=scrat.utility.measureTextWidth(a,{fontFamily:"Arial"});return Math.max(i,s)+3}scrat.ChartViewer=scrat.classDef(scrat.View,null,{sheetModel:null,viewerPanel:null,chartUpdateFunc:null,chartInstance:null,animateTime:-1,hasSlider:!1,init:function(t){this.superCall(t)},doLayout:function(t,e){this.superCall(t,e),this.chartUpdateFunc&&this.chartUpdateFunc()},empty:function(){animateTime=-1,this.stopTransition(),this.$el.empty(),$("#animateCtl").text("开始动画"),$("#animateCtl").unbind(),$("#animateReset").unbind(),$("#animateSel").unbind(),this.chartUpdateFunc=null,this.chartInstance=null},render:function(){if(this.empty(),!this.sheetModel.sheetData.checkMeasEmpty()){var e=this.sheetModel.sheetLayout.chart,a=e.type,i=e.selection;if(i&&a!==scrat.Enums.ChartType.DOT){var s,n,o,l,r=$("#pageByCnt"),c=a===scrat.Enums.ChartType.MAP,h=function(t,e){scrat.docController.dispatchPageByCmd(e.delegateTarget.data_unitID,[e.delegateTarget.data_model.all[0][t]])};for(n in i)o=this.sheetModel.getSheetUnitModel(n),r.show().css("display","inline-block"),c?(r.append("<span>"+o.name+":</span>"),l=$('<select class="pageBySingleSel sel"></select>').appendTo(r),l[0].data_model=i[n],l[0].data_unitID=n,t(l,i[n].all[1],h),i[n].selected&&(s=i[n].all[0].indexOf(i[n].selected[0]),l.val(s))):(l=$('<div class="pageByMultiSel btn">选择: '+o.name+"</div>").appendTo(r),l.length&&(l[0].data_model=i[n],l[0].data_unitID=n,l.click(function(t){scrat.sheetPanelInst.filterEditorInst.invokePageBySel(t.delegateTarget.data_unitID,t.delegateTarget.data_model.all,t.delegateTarget.data_model.selected,scrat.utility.getGlobalOffset(t.clientY+14,t.clientX-55))})))}var d=this.sheetModel.sheetData.rowCnt*this.sheetModel.sheetData.colCnt;return d>scrat.globalConst.chartDataLimit?void scrat.utility.alertError("当前的数据量为："+d+"，数据量过大，请在属性上做一定的筛选再尝试。"):void(a===scrat.Enums.ChartType.BAR||a===scrat.Enums.ChartType.LINE?this.renderABL():a===scrat.Enums.ChartType.DOT?this.renderDot():a===scrat.Enums.ChartType.MAP&&this.renderMap())}},renderABL:function(){{var t,e,a,i,n,o,l,r,c,h,d=this.sheetModel.sheetData,m=d.rowAttDescs,u=this.sheetModel.sheetLayout.chart,p=u.type,f=u.style.stack,g=u.style.horizontal?"horizontal":"vertical",v=u.style.dual_axis,x="",M="",y="",T="",C=0,D=0,b=this,k=30,I=!1,A=!1,w=!1,S=!1,L=[],P=0,N=!0,E=100,B=!0;this.sheetModel.stockPara&&!this.sheetModel.stockPara.firstRed}for(d.createABLChartData(),o=d.ABLGraphDP,l=function(t,e,a,i){return"<h3>"+t+"</h3><p>"+i.point.x+":  "+scrat.utility.formatNumbe(i.point.y,i.series.fmt,!0)+"</p>"},t=0,e=d.rowUnitIDs.length;e>t;t++)x+=this.sheetModel.getSheetUnitModel(d.rowUnitIDs[t]).name+" ";for(t=0,e=d.colUnitIDs.length;e>t;t++)a=this.sheetModel.getSheetUnitModel(d.colUnitIDs[t]),r=" / ",v?a.type===scrat.Enums.UnitType.ATTR||(2===this.sheetModel.getMeasDualAxisIdx(a.id)?(T+=(""===T?"":r)+a.name,n=a.fmt,D=Math.max(D,s(a))):(y+=(""===y?"":r)+a.name,i=a.fmt,C=Math.max(C,s(a)))):a.type!==scrat.Enums.UnitType.ATTR&&(M+=(""===M?"":r)+a.name,i=a.fmt,C=Math.max(C,s(a)));this.sheetModel.stockPara&&(this.sheetModel.stockPara.timing&&(o.timing=d.row[1].data[1]),this.sheetModel.stockPara.createDateID&&(o.createDateIdx=d.row[0].data[0].indexOf(this.sheetModel.stockPara.createDateID)),this.sheetModel.stockPara.zeroBase&&(o.zeroBase=!0),this.sheetModel.stockPara.subtractFirst&&(o.subtractFirst=!0),this.sheetModel.stockPara.axisLog&&(o.axisLog=!0),this.sheetModel.stockPara.normalize&&(o.normalize=!0),this.sheetModel.stockPara.showMaxWithdraw&&(o.showMaxWithdraw=!0),this.sheetModel.stockPara.sliderCallBck&&(o.sliderCallBck=this.sheetModel.stockPara.sliderCallBck),this.sheetModel.stockPara.unifyMeasure&&(i=n=".2f"),this.sheetModel.stockPara.hideAxisName&&!b.hasSlider&&(k=0),this.sheetModel.stockPara.hideAxis&&(c=!0,k=0),this.sheetModel.stockPara.maxBarWidth&&(E=this.sheetModel.stockPara.maxBarWidth),this.sheetModel.stockPara.hideLegend?h=!0:(this.sheetModel.stockPara.legendLeft&&(I=!0),this.sheetModel.stockPara.legendVert&&(A=!0)),this.sheetModel.stockPara.hideBrush&&(w=!0),this.sheetModel.stockPara.hideBrushLine&&(S=!0),this.sheetModel.stockPara.firstShowList&&(L=this.sheetModel.stockPara.firstShowList),this.sheetModel.stockPara.hideToolTip&&(B=!1),this.sheetModel.stockPara.hasOwnProperty("reduceXTicks")&&(N=this.sheetModel.stockPara.reduceXTicks),this.sheetModel.stockPara.hasOwnProperty("rotateLabels")&&(P=this.sheetModel.stockPara.rotateLabels)),this.$el.append($('<svg class="graph"></svg>')),nv.addGraph(function(){function t(t){d3.select(b.ID+" .graph").datum(t).call(e)}var e;if(v)e=nv.models.multiChart().x(function(t){return t.xIdx}).xAxisScale(d3.scale.ordinal().domain(m)).margin({top:30,right:D+k,bottom:20+k,left:C+k}).tooltipContent(l);else if(p===scrat.Enums.ChartType.BAR)e="horizontal"===g?nv.models.multiBarHorizontalChart():nv.models.multiBarChart(),e.x(function(t){return t.x}).y(function(t){return t.y}).showControls(!1).stacked(f===!0).reduceXTicks(N).rotateLabels(P).maxBarWidth(E).margin({top:30,right:20,bottom:20+k,left:C+k}).tooltip(l);else if(p===scrat.Enums.ChartType.LINE)if(b.hasSlider){var a;a=scrat.chartCommuData.lastExtentTOEnd?[m.length-scrat.chartCommuData.lastExtentTOEnd[1],m.length-scrat.chartCommuData.lastExtentTOEnd[0]]:[m.length>=scrat.stockEnums.DefaultSliderLength?m.length-scrat.stockEnums.DefaultSliderLength:0,m.length-1],e=nv.models.lineWithFocusChart().x(function(t){return t.xIdx}).y(function(t){return parseFloat(t.y)}).tooltips(B).tooltipContent(l).useInteractiveGuideline(!0).showLegend(!0).margin({top:30,right:20,bottom:20+k,left:C}).brushExtent(a).xAxisLabels(m),o.axisLog?(e.yScale(d3.scale.log()),e.y2Scale(d3.scale.log())):(e.yScale(d3.scale.linear()),e.y2Scale(d3.scale.linear()))}else e=nv.models.lineChart().x(function(t){return t.xIdx}).y(function(t){return parseFloat(t.y)}).useInteractiveGuideline(!0).margin({top:30,right:20,bottom:20+k,left:C+k}).xAxisScale(d3.scale.ordinal().domain(m)),e.yScale(o.axisLog?d3.scale.log():d3.scale.linear());return c&&(e.showXAxis(!1),e.showYAxis(!1),e.margin({top:0,right:0,bottom:0,left:0})),h?e.showLegend(!1):(I&&e.legendLeft(!0),A&&e.legendVert(!0)),w&&e.hideBrush(!0),S&&e.hideBrushLine(!0),0!==L.length&&e.firstShowList(L),b.hasSlider?e.yTickFormat(function(t){return scrat.utility.formatNumbe(t,i,!0)}):(e.xAxis.axisLabel(k>0?x:0),v?(e.yAxis1.axisLabel(k>0?y:0),e.yAxis2.axisLabel(k>0?T:0)):e.yAxis.axisLabel(k>0?M:0),e.showAnimation(!scrat.disableAnimation&&d.colTotalCnt*d.rowTotalCnt<scrat.animationThreshold),v?(e.yAxis1.tickFormat(function(t){return scrat.utility.formatNumbe(t,i)}),e.yAxis2.tickFormat(function(t){return scrat.utility.formatNumbe(t,n)})):e.yAxis.tickFormat(function(t){return scrat.utility.formatNumbe(t,i)})),t(o),b.chartUpdateFunc=e.update,b.chartInstance=e,e})},renderDot:function(){var e,n,o,l,r,c=this.sheetModel.sheetData,h=c.rowAttDescs,d=this.sheetModel.sheetLayout.chart,m=d.type,u=this,p=c.colAttEleCnt>1&&m===scrat.Enums.ChartType.DOT,f=0,g=c.measNames.length>1?1:0,v=2,x=c.measNames[f],M=c.measNames[g],y=c.measNames[v],T=this.sheetModel.getSheetUnitFormat(c.measIDs[f]),C=this.sheetModel.getSheetUnitFormat(c.measIDs[g]),D=this.sheetModel.getSheetUnitFormat(c.measIDs[v]),b=s(this.sheetModel.getSheetUnitModel(c.measIDs[g]));c.createDotChartData({xMetricIdx:f,yMetricIdx:g,zMetricIdx:v}),n=c.dotGraphDP,o=c.dotColorBy,l=function(t,e,a,i){return"<h3>"+i.point.name+" "+i.point.seriesName+"</h3><p>"+x+": "+scrat.utility.formatNumbe(e,T)+"</p><p>"+M+": "+scrat.utility.formatNumbe(a,C)+"</p>"+(y?"<p>"+y+": "+scrat.utility.formatNumbe(i.point.size,D)+"</p>":"")},r=p&&(c.rowCnt<=10&&o.length>1||1===c.rowCnt),this.$el.append($('<svg class="graph"></svg>')),nv.addGraph(function(){function s(t){r&&d(t,.5),d3.select(u.ID+" .graph").datum(t).call(D)}function d(t,e){var a,i,s=function(t){var a,i;for(a=0,i=t.length;i>a;a++)t[a]&&(t[a].alpha=e)};if(t instanceof Array)for(a=0,i=t.length;i>a;a++)s(t[a].values);else s(t.values)}function m(t){stopTransition(),t>=0&&A-1>=t?(s([n[t]]),u.animateTime=t):(s(n),u.animateTime=0)}function f(){var t=0;u.animateTime>=0&&u.animateTime<A-1&&(t=u.animateTime);var e=d3.interpolateNumber(t,A-1);return function(t){g(e(t))}}function g(t){return u.animateTime=t,.01>A-1-t?(s(n),void i()):void d3.select(u.ID+" .graph").datum(v(t)).call(D)}function v(t){var i,s=[{}],o=Math.round(t);for(s[0].values=[],s[0].key=n[o].key,e=0;I>e;e++)if(s[0].values[e]={},i=s[0].values[e],void 0!==n[Math.floor(t)].values[e]&&(k[e]=Math.floor(t)),void 0===n[Math.ceil(t)].values[e])void 0!==n[Math.floor(t)].values[e]?scrat.combine(i,n[k[e]].values[e]):void 0===k[e]?delete s[0].values[e]:scrat.combine(i,n[k[e]].values[e]);else if(void 0===k[e])scrat.combine(i,n[Math.ceil(t)].values[e]);else{var l=n[k[e]].values[e],h=n[Math.ceil(t)].values[e],m=Math.ceil(t)-t;scrat.combine(i,n[Math.round(t)].values[e]||h),i.x=h.x*(1-m)+l.x*m,i.y=h.y*(1-m)+l.y*m,i.size=h.size*(1-m)+l.size*m}if(r){var u=.5;for(e=Math.floor(t);e>=0;e--)d(n[e],.15),s.push(n[e]),u*=.9;d(s[0],.5),s[1].key+="sfsfff"}return $("#animateSel").val(Math.round(t)),$("#animateSlider").slider("option","value",Math.round(t)),a(c.colAttDescs[Math.round(t)]),void 0!==s&&0!==s.length&&0!==s[0].values.length?s:void 0}var D=nv.models.scatterChart().useVoronoi(!1).tooltipContent(l).showAnimation(!scrat.disableAnimation&&!p&&c.colTotalCnt*c.rowTotalCnt<scrat.animationThreshold).sizeRange(y?[16,512]:[64,64]).margin({top:30,right:20,bottom:50,left:b+30}).legendDP(o);if(o.length<=1&&D.showLegend(!1),D.xAxis.axisLabel(x),D.yAxis.axisLabel(M),D.yAxis.tickFormat(function(t){return scrat.utility.formatNumbe(t,C)}),D.xAxis.tickFormat(function(t){return scrat.utility.formatNumbe(t,T)}),s(n),u.chartUpdateFunc=D.update,p){D.inAnimate(!0),$("#animateCnt").show().css("display","inline-block");var k,I=h.length,A=c.colAttEleCnt,w=$('<div class="animateLabel"></div>');$("#animateSlider").slider({max:A-1,value:0,slide:function(t,e){"继续动画"===$("#animateCtl").text()&&(u.animateTime=e.value,w.text(c.colAttDescs[e.value]))}}).hide(),u.$el.prepend(w.css({top:20,left:b+30})),u.animateTime=0,$("#animateCtl").click(function(){"开始动画"===$("#animateCtl").text()?(k=[],u.animateTime=0,u.stopTransition(),u.startTransition(800*A,f),$("#animateCtl").text("暂停动画")):"暂停动画"===$("#animateCtl").text()?(u.stopTransition(),$("#animateCtl").text("继续动画")):"继续动画"===$("#animateCtl").text()&&(u.animateTime>=0&&u.animateTime<A-1&&u.startTransition(800*(A-u.animateTime),f),$("#animateCtl").text("暂停动画"))}),$("#animateReset").click(function(){$("#animateCtl").text("开始动画"),i(),u.stopTransition(),s(n)}),t($("#animateSel"),c.colAttDescs,m,!0)}return D})},renderMap:function(){function s(){var t=k.sheetModel.getSheetUnitModel(_.last(p.column)[I.colorMetricIdx]);I.maxValue=t.rng[1],I.minValue=t.rng[0],I.colorMetricName=u.measNames[I.colorMetricIdx],I.colorMetricFmt=k.sheetModel.getSheetUnitFormat(u.measIDs[I.colorMetricIdx]),$(k.ID+" .min").text(scrat.utility.formatNumbe(I.minValue,I.colorMetricFmt)),$(k.ID+" .max").text(scrat.utility.formatNumbe(I.maxValue,I.colorMetricFmt))}function n(){e(T,["colors","color","sentIdx"]),u.combineMapData(u.rowUnitIDs.indexOf(p.geo_unit_id),I.colorMetricIdx,T)}function o(t){var e=scrat.debugMode?$("#ConfigColor1").val():"83C78C",a=scrat.debugMode?$("#ConfigColor2").val():"C43136",i=scrat.utility.getColorInRange((t-I.minValue)/(I.maxValue-I.minValue),parseInt(e,16),parseInt(a,16),15658734);return scrat.utility.getCSSColor(i)}function l(t){t.attr("fill",function(t){return null===t.properties.color||""===t.properties.color||void 0===t.properties.color?"#eeeeee":o(t.properties.color)})}function r(t){return t.id}function c(t){return $.each(T,function(e,a){var i=a.properties;if(delete i.color,void 0===i.colors)return null;if(""!==i.colors[Math.floor(t)]&&(i.sentIdx=Math.floor(t)),""===i.colors[Math.ceil(t)])i.color=""!==i.colors[Math.floor(t)]?i.colors[i.sentIdx]:void 0===i.sentIdx?"":i.colors[i.sentIdx];else{var s=void 0===i.sentIdx?"":i.colors[i.sentIdx],n=i.colors[Math.ceil(t)],o=Math.ceil(t)-t;i.color=n*(1-o)+s*o}}),$("#animateSel").val(Math.round(t)),T}function h(t){k.stopTransition(),e(T,["sentIdx"]),t>=0&&f-1>=t&&C.selectAll("path").data(c(t),r).call(l),k.animateTime=t}function d(){function o(){var t=0;k.animateTime>=0&&k.animateTime<f-1&&(t=k.animateTime);var e=d3.interpolateNumber(t,f-1);return function(t){d(e(t))}}function d(t){return C.selectAll("path").data(c(t),r).call(l),.01>f-1-t?void i():($("#animateSlider").slider("option","value",Math.round(t)),a(u.colAttDescs[Math.round(t)]),void(k.animateTime=t))}var m=u.colAttDescs;s(),n(T),C.selectAll("path").data(c(0)).enter().append("svg:path").attr("d",L).call(l).on("mousemove",function(t){if(void 0!==t.properties.chnName&&void 0!==t.properties.color){var e="<h3>"+t.properties.chnName+"</h3><p>"+I.colorMetricName+": "+scrat.utility.formatNumbe(t.properties.color,I.colorMetricFmt)+"</p>";nv.tooltip.show([d3.event.clientX,d3.event.clientY],e,void 0,void 0,this.offsetParent)}}).on("mouseout",function(){nv.tooltip.cleanup()}),g&&(v=$('<div class="animateLabel"></div>'),k.$el.prepend(v.css({top:0,left:20})),$("#animateSlider").slider({max:f-1,value:0,slide:function(t,e){"继续动画"===$("#animateCtl").text()&&(k.animateTime=e.value,v.text(u.colAttDescs[e.value]))}}).hide(),$("#animateCnt").show().css("display","inline-block"),$("#animateCtl").click(function(){"开始动画"===$("#animateCtl").text()?(k.animateTime=0,k.stopTransition(),k.startTransition(800*f,o),$("#animateCtl").text("暂停动画")):"暂停动画"===$("#animateCtl").text()?(k.stopTransition(),$("#animateCtl").text("继续动画")):"继续动画"===$("#animateCtl").text()&&(k.animateTime>=0&&k.animateTime<f-1&&k.startTransition(800*(f-k.animateTime),o),$("#animateCtl").text("暂停动画"))}),$("#animateReset").click(function(){$("#animateCtl").text("开始动画"),k.stopTransition(),e(T,["sentIdx"]),C.selectAll("path").data(c(0),r).call(l),i()}),t($("#animateSel"),m,h))}var m,u=this.sheetModel.sheetData,p=this.sheetModel.sheetLayout.chart,f=u.colAttEleCnt,g=f>1;if("city"===p.geo_level)m=2;else{if("province"!==p.geo_level)return;m=1}g&&$("#animateCnt").show().css("display","inline-block"),this.$el.append($('<svg class="graph"></svg><div class="legendCnt"><div class="gradient"></div><div class="min label"></div><div class="max label"></div></div>'));var v,x,M,y,T,C,D=this.$el.actual("width"),b=this.$el.actual("height"),k=this,I={colorMetricIdx:0};if(u.measNames.length>1){var A,w=$("#pageByCnt");w.show().css("display","inline-block"),w.append("<span>度量:</span>"),A=$('<select class="pageBySingleSel sel"></select>').appendTo(w),t(A,u.measNames,function(t){I.colorMetricIdx=parseInt(t),s(),n(),h(k.animateTime>=0&&k.animateTime<=f-1?k.animateTime:0)})}3*b/2>4*D/3?(y=4*D/3,x=D/2,M=8*x/9):(y=3*b/2,M=b/2,x=9*M/8),$(this.ID+" .legendCnt").css({top:b-50,left:30,width:.8*x-30});var S=d3.geo.azimuthal().mode("orthographic").origin([102,36]).scale(y).translate([x,M]),L=d3.geo.path().projection(S),P=d3.select(k.ID+" .graph").attr("width",D).attr("height",b),N="../static/mapLib/adm"+m+"_Extract.json";C=P.append("svg:g").attr("id","states"),void 0===scrat.geoData[m]?d3.json(N,function(t){scrat.geoData[m]=t,T=t,d()}):(T=scrat.geoData[m],d())},startTransition:function(t,e){d3.select(this.ID+" .graph").transition().duration(t).ease("linear").tween("date",e).each("end",function(){$("#animateCtl").text("开始动画")})},stopTransition:function(){d3.select(this.ID+" .graph").transition().duration(0)}})}();
;!function(){scrat.InfoPanel=scrat.classDef(scrat.View,null,{sheetModel:null,init:function(t){var e=this,a=$(this.ID+" .titleCnt .add");this.superCall(t),$(this.ID+" .txt").click(function(){$(e.ID+" .txt").removeClass("highlight"),$(this).hasClass("filter")?($(this).addClass("highlight"),$("#filterListCnt").show(),$("#paraListCnt").hide()):$(this).hasClass("para")&&($(this).addClass("highlight"),$("#filterListCnt").hide(),$("#paraListCnt").show())}),a.click(function(t){var e,a,i=$("#cubeAsFilterSelCnt"),n=scrat.dsList.models;for(i.find("select").empty(),e=0,a=n.length;a>e;e++)i.find("select").append('<option value="'+e+'">'+n[e].name+"</option>");scrat.utility.addPopup(i.css(scrat.utility.getGlobalOffset(t.clientY+15,t.clientX-80))),setTimeout(function(){$("#generalTooltip").hide()},200)}),$("#cubeAsFilterSelCnt").find(".okBtn").click(function(){scrat.utility.removePopup();var t=$("#cubeAsFilterSelCnt").find("select");e.controller.dispatchCubeAsFilterCmd(scrat.dsList.models[parseInt(t.val())].id),$(e.ID+" .titleCnt .txt.filter").trigger("click")}),scrat.utility.bindTooltip(a,"添加数据集为筛选条件"),this.bindHandlerToPara($("#paraListCnt input"),$("#paraListCnt .delIcon"))},doLayout:function(t,e){this.superCall(t,e),this.sheetModel&&this.render()},empty:function(){this.emptyFilterCnt(),this.emptyParaCnt()},emptyFilterCnt:function(){$("#filterListCnt").empty()},emptyParaCnt:function(){$("#paraListCnt .itemCnt:not(:last)").remove()},render:function(){this.renderFilterCnt(),this.renderParaCnt()},renderFilterCnt:function(){if(this.emptyFilterCnt(),this.sheetModel&&!this.sheetModel.isEmpty()){var t,e,a,i,n,s,l,r,d,c=this.$Obj().width(),o=0,p=this;translateOp=function(t){switch(t){case scrat.Enums.MeasFilterType.VALUE_BETWEEN:return" 介于 ";case scrat.Enums.MeasFilterType.TOP:return" 前 ";case scrat.Enums.MeasFilterType.BOTTOM:return" 后 ";case scrat.Enums.MeasFilterType.NOTNULL:return" 非空 ";case scrat.Enums.MeasFilterType.NULL:return" 空 ";case scrat.Enums.MeasFilterType.GE:return" 晚于 ";case scrat.Enums.MeasFilterType.LE:return" 早于 ";default:return""}},addFilterItem=function(t,e,a){var i=$('<div class="filterListItem">'+e+"</div>"),n=$('<div class="delIcon"></div>');n.prop("data_unitID",t).click(function(t){var e=t.delegateTarget.data_unitID;a?p.controller.dispatchCubeAsFilterCmd(e,!0):(delete p.sheetModel.filterModel[e],scrat.docController.dispatchFilter(e))}),a||i.prop("data_unitID",t).click(function(t){var e=t.delegateTarget.data_unitID;scrat.docController.unitFilterTrigger(e,scrat.utility.getGlobalOffset(t.clientY+20,t.clientX))}),i.width(c-40),$("#filterListCnt").append(i),$("#filterListCnt").append(n),scrat.utility.handleTruncationTxt(i[0]),o++},$("#filterListCnt").width(c),$("#paraListCnt").width(c);for(a in this.sheetModel.filterModel)if("cube"!==a)e=this.sheetModel.getSheetUnitModel(a),i=this.sheetModel.filterModel[a],i&&(t=e.name,e.getType()===scrat.Enums.UnitType.ATTR?(i.op===scrat.Enums.MeasFilterType.IN?(t+=" 属于 ( ",n=0,$.each(i.desc,function(e,a){e>=10||(0!==n&&(t+=", "),n=1,t+=a.toString())}),t+=i.desc.length>10?" 等)":" )"):i.op===scrat.Enums.MeasFilterType.VALUE_BETWEEN?(t+=translateOp(i.op),t+="[ "+i.desc[0]+", "+i.desc[1]+" ]"):i.op===scrat.Enums.MeasFilterType.LE?(t+=translateOp(scrat.Enums.MeasFilterType.VALUE_BETWEEN),t+="[ , "+i.desc+"]"):i.op===scrat.Enums.MeasFilterType.GE?(t+=translateOp(scrat.Enums.MeasFilterType.VALUE_BETWEEN),t+="[ "+i.desc+", ]"):(t+=translateOp(i.op),t+=i.desc),addFilterItem(e.id,t)):e.getType()===scrat.Enums.UnitType.MEAS&&(t+=translateOp(i.op),i.val instanceof Array?t+="[ "+i.val[0]+", "+i.val[1]+" ]":void 0!==i.val&&(t+=i.val),addFilterItem(e.id,t)));else{var u,h,f=this.sheetModel.filterModel.cube;if(f)for(s=0,l=f.length;l>s;s++){if(u=f[s].sheet_unit_names,u&&u.length){for(h="",r=0,d=u.length;d>r;r++)h+=0===r?(d>1?"(":"")+u[r]:", "+u[r];h+=(d>1?")":"")+" 属于 "+f[s].name}else h=f[s].name;addFilterItem(f[s].id,h,!0)}}o>3&&$(".filterListItem").width(c-40-scrat.globalConst.scrollBarSize)}},renderParaCnt:function(){if(this.emptyParaCnt(),this.sheetModel){var t,e,a=this.sheetModel.params||[];for(t=0,e=a.length;e>t;t++){var i=$('<div class="itemCnt"><input type="text" class="name" readonly="readonly"/><span class="txt">-</span><input type="text" class="value" placeholder="值"/><div class="delIcon"></div></div>');i.find(".name").val(a[t].name),i.find(".value").val(a[t].val),i.find(".delIcon").show(),this.bindHandlerToPara(i.find("input"),i.find(".delIcon")),$("#paraListCnt .itemCnt:last").before(i)}}},bindHandlerToPara:function(t,e){t.focusout(_.bind(this.paraChange,this)),t.keydown(function(t){13===t.keyCode&&(t.preventDefault(),$(this).blur())}),e.click(function(){var t=$(this).parent();scrat.docController.dispatchParaDefine(t.find(".name").val(),t.find(".value").val(),!0),t.remove()})},paraChange:function(t){var e=$(t.delegateTarget),a=e.parent().find(".name"),i=e.parent().find(".value");""===a.val()||""===i.val()||e[0].readOnly||(e.parent().find(".delIcon").show(),this.controller.dispatchParaDefine(e.parent().find(".name").val(),e.parent().find(".value").val()));var n,s=$("#paraListCnt .name:last"),l=$("#paraListCnt .value:last");""!==s.val()&&""!==l.val()&&(n=$('<div class="itemCnt"><input type="text" class="name" placeholder="参数名称"/><span class="txt">-</span><input type="text" class="value" placeholder="值"/><div class="delIcon"></div></div>'),$("#paraListCnt").append(n),this.bindHandlerToPara(n.find("input"),n.find(".delIcon")))},findCntByName:function(t,e){var a,i,n,s=$("#filterListCnt .delIcon");for(a=0,i=s.length;i>a;a++)if(n=this.sheetModel.getSheetUnitModel(s[a].data_unitID),n.name===t)return"delete"===e?$(s[a]):$(s[a]).prev();return null}})}();
;!function(){scrat.SheetPanel=scrat.classDef(scrat.View,null,{sheetModel:null,analyzePanel:null,viewerPanel:null,infoPanel:null,filterEditorInst:null,init:function(e){this.superCall(e),this.analyzePanel=new scrat.AnalyzePanel({ID:"#analyzePanel",controller:scrat.docController}),this.viewerPanel=new scrat.ViewerPanel({ID:"#viewerPanel",controller:scrat.docController}),this.infoPanel=new scrat.InfoPanel({ID:"#filterInfPanel",controller:scrat.docController}),this.filterEditorInst=new scrat.FilterEditor({ID:"#filterEditor",controller:scrat.docController})},doLayout:function(e,t){this.superCall(e,t);var i,l=e,n=t,a=scrat.globalConst,s=3;i=l*a.analyzePanelPerc,scrat.displayMtd?(this.analyzePanel.$el.hide(),this.infoPanel.$el.hide(),this.viewerPanel.$el.css({top:0,left:0}),this.viewerPanel.doLayout(l,n)):(this.analyzePanel.$el.css({top:0,left:0}).show(),this.analyzePanel.doLayout(i-2*scrat.globalConst.borderThick,a.topPanelHeight-2*scrat.globalConst.borderThick),this.viewerPanel.$el.css({top:a.topPanelHeight,left:0}),this.viewerPanel.doLayout(l,n-a.topPanelHeight),l-=i,this.infoPanel.$el.css({top:0,left:i+s}).show(),this.infoPanel.doLayout(l-2*scrat.globalConst.borderThick-s,a.topPanelHeight-2*scrat.globalConst.borderThick))},empty:function(){this.viewerPanel.empty(),this.infoPanel.empty(),this.analyzePanel.empty()},setModel:function(e){this.sheetModel=this.filterEditorInst.sheetModel=this.infoPanel.sheetModel=e,this.viewerPanel.setModel(e),this.analyzePanel.setModel(e),this.render()},render:function(){return this.analyzePanel.render(),this.viewerPanel.render(),this.infoPanel.render(),this},unitContextChange:function(){this.analyzePanel.analyPanelUpdate()},contextPanelChange:function(){this.viewerPanel.contextPanelChange()},unitFilterTrigger:function(e,t){this.filterEditorInst.invokeFilter(e,t)}}),scrat.SheetSwitchCnt=scrat.classDef(scrat.View,null,{minWidth:96,init:function(e){this.superCall(e);var t=$(this.ID+" .new"),i=this,l=$("#sheetEditor");t.click(function(){i.controller.dispatchAddSheetCmd()}),l.find(".rename").click(function(e){var t=e.delegateTarget.parentNode.data_target,i=$(t).find(".sheetUnitTxt");i.prop("readonly",!1),i.focus(),i[0].selectionStart=0,i[0].selectionEnd=20,scrat.utility.removePopup()}),l.find(".delete").click(function(e){i.deleteSheet(e.delegateTarget.parentNode.data_target),scrat.utility.removePopup()}),l.find(".save").click(function(e){i.controller.dispatchSheetSave(e.delegateTarget.parentNode.data_target.data_view.model.id),scrat.utility.removePopup()}),l.find(".dup").click(function(e){var t=e.delegateTarget.parentNode.data_target,l=t.data_view.model;i.controller.dispatchAddSheetCmd(l.name+"副本",l.id),scrat.utility.removePopup()}),l.find(".export").click(function(){scrat.docController.dispatchExportCmd(scrat.sheetList.getCurrentSheetModel().getLayoutType()===scrat.Enums.ViewLayoutType.GRID?"csv":"image"),scrat.utility.removePopup()}),$(this.ID+" .icon").click(function(){if($(this).hasClass("enabled")){var e,t=$(i.ID+" .sheetUnitCnt"),l=t.length,n=0,a=i.$el.find(".scrollable"),s=a.scrollLeft();for(e=0;l>e;e++){if(n===s){if($(this).hasClass("right")){a.scrollLeft(n+$(t[e]).width());break}if(e>0){a.scrollLeft(n-$(t[e-1]).width());break}}else if(n>s){if($(this).hasClass("right")){a.scrollLeft(n);break}a.scrollLeft(n-$(t[e-1]).width());break}n+=$(t[e]).width()}i.updateIcons()}})},doLayout:function(e,t){this.superCall(e,t),$(this.ID+" .scrollable").width(e-50),this.updateScrollable()},render:function(){$(this.ID+" .sheet").remove();var e=this.model.sheetIDs.length;if(e>0){var t,i,l=this,n=_.bind(function(e){this.switchSheet(e.delegateTarget.data_view.model)},this);for(t=0;e>t;t++)if(i=this.model.models[this.model.sheetIDs[t]]){var a=new scrat.View({$el:$('<div class="sheetUnitCnt sheet"><textarea class="sheetUnitTxt" readonly="readonly" maxlength="20" spellcheck="false">'+i.name+"</textarea></div>")});a.model=i,a.listenTo("click",function(e){n(e)});var s=function(e){if("keydown"===e.type&&13===e.keyCode)return e.preventDefault(),void $(e.delegateTarget).find(".sheetUnitTxt").blur();if("keydown"!==e.type){var t=$(e.delegateTarget).find(".sheetUnitTxt");t.attr("readonly","readonly");var i=e.delegateTarget.data_view.model,n=t.val();i.name!==n&&(i.name=n,this.controller.dispatchSheetNameCgCmd(i.id,i.name,function(e){var l=e.data.name;t.val(l),i.name=l}),l.updateScrollable())}},o=function(e){var t=e.val(),i=scrat.utility.measureTextWidth(t,{fontSize:e.css("fontSize"),fontFamily:e.css("fontFamily"),fontStyle:e.css("fontStyle")});i=i>l.minWidth?i:l.minWidth,i+=6,e.width(i),e.parent().width(i+17)};a.listenTo("focusout",_.bind(s,this)),a.listenTo("keydown",_.bind(s,this)),a.listenTo("keyup",function(e){var t=$(e.delegateTarget).find(".sheetUnitTxt");o(t)}),a.listenTo("dblclick",function(e){$(e.delegateTarget).find(".sheetUnitTxt").prop("readonly",!1),$(e.delegateTarget).find(".sheetUnitTxt").focus()});var r=new scrat.View({$el:$('<div class="editIcon"></div>')});r.listenTo("click",_.bind(l.editorInvoke,l)),a.$el.append(r.$el),r.model=i,a.listenTo("mouseenter",function(){$(this).find(".editIcon").show()}),a.listenTo("mouseleave",function(){$(this).find(".editIcon").hide()}),this.$el.find(".cnt").append(a.$el),o(a.$el.find(".sheetUnitTxt"))}}this.$el.find(".cnt").append($(this.ID+" .new")),this.updateSheetsHighlight(),this.updateScrollable(!0)},editorInvoke:function(e){e.stopPropagation(),e.preventDefault();var t=$("#sheetEditor"),i=e.delegateTarget.data_view.model.id===this.model.currentSheetID;t[0].data_target=e.delegateTarget.parentNode,i?t.find(".export").show():t.find(".export").hide(),scrat.utility.addPopup(t.css(scrat.utility.getGlobalOffset(e.clientY-100-(i?25:0),e.clientX)))},deleteSheet:function(e){var t=e.data_view.model,i=this.model.getNext(t.id);this.controller.dispatchDeleteSheetCmd(t.id),this.model.deleteSheet(t.id),$(e).remove(),-1!==i?this.switchSheet(this.model.models[i]):this.controller.dispatchAddSheetCmd(),this.updateScrollable()},deleteSheetsByIDs:function(e){var t,i=0,l=e.length;for(this.controller.dispatchDeleteSheetCmd(e);l>i;i++)t=this.model.getNext(e[i]),this.model.deleteSheet(e[i]);$(this.ID+" .sheet").each(function(t,i){i.data_view&&-1!==e.indexOf(i.data_view.model.id)&&$(i).remove()}),-1!==t?this.switchSheet(this.model.models[t]):this.controller.dispatchAddSheetCmd(),this.updateScrollable()},switchSheet:function(e){this.model.currentSheetID!==e.id&&(this.model.currentSheetID=e.id,this.controller.dispatchSwitchSheetCmd(e.id),e.updated&&(this.sheet.setModel(e),scrat.dsPanelInst.updatePrimary()),this.updateSheetsHighlight())},updateSheetsHighlight:function(){var e=this.model.currentSheetID;$(this.ID+" .sheet").each(function(t,i){i.data_view&&(e===i.data_view.model.id?$(i).addClass("highlight"):$(i).removeClass("highlight"))})},updateScrollable:function(e){for(var t=$(this.ID+" .sheetUnitCnt"),i=$(this.ID+" .icon"),l=$(this.ID+" .scrollable"),n=0,a=t.length,s=0;a>n;n++)s+=$(t[n]).width();$(this.ID+" .cnt").width(s),this.width-s>=300?i.hide():i.show(),e&&s>l.width()&&$(this.ID+" .scrollable").scrollLeft(s-l.width()),this.updateIcons()},updateIcons:function(){var e=$(this.ID+" .scrollable"),t=$(this.ID+" .cnt"),i=$(this.ID+" .icon"),l=e.width(),n=t.width(),a=e.scrollLeft();l>=n?i.removeClass("enabled"):(n>a+l?i.filter(".right").addClass("enabled"):i.filter(".right").removeClass("enabled"),a>0?i.filter(".left").addClass("enabled"):i.filter(".left").removeClass("enabled"))},findCntByName:function(e,t){var i=$(this.ID+" .sheet.highlight");return"config"===t?i.find(".editIcon"):i}})}();
;!function(){scrat.ViewerPanel=scrat.classDef(scrat.View,null,{sheetModel:null,viewers:[],currentViewer:null,viewType:scrat.Enums.ViewLayoutType.GRID,doLayout:function(e,t){this.superCall(e,t);var i=scrat.displayMtd===scrat.Enums.DisplayMethod.VIEWER?0:28;scrat.displayMtd===scrat.Enums.DisplayMethod.VIEWER&&$("#viewerCtlCnt").hide(),$("#mainView").css({top:i}),this.currentViewer&&this.currentViewer.doLayout(e-10,t-(i+5))},init:function(e){this.superCall(e),this.createViewer();var t=this;$("#chartTypeSel").change(function(){t.visTypeChange(this.value)}),$("#viewTypeGridCnt").click(_.bind(function(){var e=function(e){scrat.utility.checkResponseData(e)&&$("#chartTypeSel").hide()};this.sheetModel.getLayoutType()!==scrat.Enums.ViewLayoutType.GRID&&this.controller.dispatchSwitchLayout("grid",null,!0,e)},this)),$("#viewTypeChartCnt").click(_.bind(function(){var e=function(e){scrat.utility.checkResponseData(e)&&$("#chartTypeSel").show().css("display","inline-block")};this.sheetModel.getLayoutType()===scrat.Enums.ViewLayoutType.GRID&&this.controller.dispatchSwitchLayout("chart",null,!0,e)},this)),$("#maximizeCnt").click(_.bind(function(){scrat.displayMtd?$("#maximizeCnt").removeClass("highlight"):$("#maximizeCnt").addClass("highlight"),scrat.displayMtd=!scrat.displayMtd,scrat.docController.doLayout()},this))},empty:function(){this.currentViewer&&this.currentViewer.empty(),nv.render.queue=[],$("#viewerCtlCnt").hide(),$("#dropCnt").hide(),$("#animateCnt").hide(),$("#pageByCnt").hide(),$("#pageByCnt").empty(),$("#totalNum").text("")},updateVisTypeCtl:function(){scrat.displayMtd!==scrat.Enums.DisplayMethod.VIEWER&&$("#viewerCtlCnt").show(),this.sheetModel.getLayoutType()===scrat.Enums.ViewLayoutType.CHART?($("#chartTypeSel").show().css("display","inline-block"),$("#chartTypeSel").val(this.sheetModel.sheetLayout.chart.type),this.updateChartSelList(this.sheetModel.sheetLayout)):$("#chartTypeSel").hide()},contextPanelChange:function(){this.currentViewer&&this.currentViewer.updateHighlight&&this.currentViewer.updateHighlight()},setModel:function(e){this.sheetModel=e,this.currentViewer.sheetModel=e},render:function(){return this.empty(),!this.sheetModel||this.sheetModel.isEmpty()?void $("#dropCnt").show():(this.createViewer(),this.currentViewer.render(),this.updateSummaryInfo(),void this.updateVisTypeCtl())},updateSummaryInfo:function(){var e="行数: ",t=this.sheetModel.primary.cube_name;t?$("#totalNum").text(e+this.sheetModel.sheetData.rowTotalCnt+". 主题数据集: "+t):$("#totalNum").text()},updateChartSelList:function(e){$("#chartTypeSel").children().each(function(t,i){var s=i.value;-1!==e.chart.avail_types.indexOf(s)?$(i).css("display","block"):$(i).css("display","none")})},visTypeChange:function(e){e!==this.sheetModel.sheetLayout.chart.type&&(this.sheetModel.sheetLayout.chart.type=e,this.controller.dispatchSwitchLayout("chart",e,!0))},visTypeChgCallbck:function(e){scrat.utility.checkResponseData(e)&&this.sheetModel.updateLayout(e.data),this.updateChartSelList(this.sheetModel.sheetLayout),this.render()},createViewer:function(){this.sheetModel&&this.sheetModel.getLayoutType()===scrat.Enums.ViewLayoutType.CHART?(this.currentViewer=new scrat.ChartViewer({ID:"#mainView",controller:scrat.docController,sheetModel:this.sheetModel,viewerPanel:this}),this.highlightIcon(scrat.Enums.ViewLayoutType.CHART)):(this.currentViewer=new scrat.GridViewer({ID:"#mainView",controller:scrat.docController,sheetModel:this.sheetModel,viewerPanel:this}),this.highlightIcon(scrat.Enums.ViewLayoutType.GRID))},highlightIcon:function(e){e===scrat.Enums.ViewLayoutType.GRID?($("#viewTypeGridCnt").addClass("highlight"),$("#viewTypeChartCnt").removeClass("highlight")):e===scrat.Enums.ViewLayoutType.CHART&&($("#viewTypeGridCnt").removeClass("highlight"),$("#viewTypeChartCnt").addClass("highlight"))},findCntByName:function(e,t,i){if("grid"===t)return this.currentViewer.findCntByName(e,i);if("typeSel"===t)return $("grid"===e?"#viewTypeGridCnt":"#viewTypeChartCnt");if("chartSel"===t)return $("#chartTypeSel");if("animate"===t){if("start"===e)return $("start"===e?"#animateCtl":"reset"===e?"#animateReset":"#animateSel")}else if("pageby"===t){var s,a,r=$("#pageByCnt .pageByMultiSel");for(s=0,a=r.length;a>s;s++)if(-1!==r[s].data_unitID.indexOf(e))return $(r[s])}return null}})}();